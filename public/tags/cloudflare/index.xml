<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Cloudflare on 为霜的博客</title>
    <link>https://blog.jiyi27.com/tags/cloudflare/</link>
    <description>Recent content in Cloudflare on 为霜的博客</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <lastBuildDate>Sun, 20 Oct 2024 10:42:22 +0000</lastBuildDate><atom:link href="https://blog.jiyi27.com/tags/cloudflare/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Cloudflare R2 Pre-signed URL Cross-Origin Issue</title>
      <link>https://blog.jiyi27.com/posts/bugs/011-cloudflare-r2/</link>
      <pubDate>Sun, 20 Oct 2024 10:42:22 +0000</pubDate>
      
      <guid>https://blog.jiyi27.com/posts/bugs/011-cloudflare-r2/</guid>
      <description>&lt;h2 id=&#34;1-problem-description&#34;&gt;1. Problem description&lt;/h2&gt;
&lt;p&gt;获取到Cloudflare R2的Pre-signed URL后，使用网页上传文件时，总是返回各自各样的错误, 在网页遇到的是跨域问题, 总是报错说 pre flight request failed.&lt;/p&gt;
&lt;p&gt;查了一圈, 说是请求头的问题, 需要在平台设置 &lt;code&gt;Access-Control-Allow-Origin&lt;/code&gt; 和 &lt;code&gt;Access-Control-Allow-Headers&lt;/code&gt; 等请求头. 后面设置了, 也无济于事. 有的说得包含 Content-type 头, 即若前端通过pre-signed url上传文件, 设置了 Content-Type 头, 则后端请求pre-signed url时, 也必须设置 Content-Type 头. 什么必须要同一个方法 PUT, 都设置 都不行,&lt;/p&gt;
&lt;p&gt;后来使用 SwiftUI 开发, 想着换个环境, 就没有跨域问题了吧, 可是还是报错, 报错信息是 401, 没有权限.&lt;/p&gt;
&lt;h2 id=&#34;2-problem-analysis&#34;&gt;2. Problem analysis&lt;/h2&gt;
&lt;p&gt;结果问题出现在 Cloudflare R2 和 AWS S3 签名版本兼容问题上:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Cloudflare R2 requires presigned URLs to be generated using AWS Signature Version 4. Any other signature version will result in authentication failures.&lt;/p&gt;</description>
      <content>&lt;h2 id=&#34;1-problem-description&#34;&gt;1. Problem description&lt;/h2&gt;
&lt;p&gt;获取到Cloudflare R2的Pre-signed URL后，使用网页上传文件时，总是返回各自各样的错误, 在网页遇到的是跨域问题, 总是报错说 pre flight request failed.&lt;/p&gt;
&lt;p&gt;查了一圈, 说是请求头的问题, 需要在平台设置 &lt;code&gt;Access-Control-Allow-Origin&lt;/code&gt; 和 &lt;code&gt;Access-Control-Allow-Headers&lt;/code&gt; 等请求头. 后面设置了, 也无济于事. 有的说得包含 Content-type 头, 即若前端通过pre-signed url上传文件, 设置了 Content-Type 头, 则后端请求pre-signed url时, 也必须设置 Content-Type 头. 什么必须要同一个方法 PUT, 都设置 都不行,&lt;/p&gt;
&lt;p&gt;后来使用 SwiftUI 开发, 想着换个环境, 就没有跨域问题了吧, 可是还是报错, 报错信息是 401, 没有权限.&lt;/p&gt;
&lt;h2 id=&#34;2-problem-analysis&#34;&gt;2. Problem analysis&lt;/h2&gt;
&lt;p&gt;结果问题出现在 Cloudflare R2 和 AWS S3 签名版本兼容问题上:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Cloudflare R2 requires presigned URLs to be generated using AWS Signature Version 4. Any other signature version will result in authentication failures.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;这不, 什么都不用改, 只要把签名版本改成4就可以了:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-csharp&#34; data-lang=&#34;csharp&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;class&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;R2Service&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;{
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;readonly&lt;/span&gt; IAmazonS3 _r2Client;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;private&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;readonly&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;string&lt;/span&gt; _bucketName;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; R2Service(IConfiguration configuration)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; accessKey = configuration[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;AWS:S3:AccessKey&amp;#34;&lt;/span&gt;];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; secretKey = configuration[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;AWS:S3:SecretKey&amp;#34;&lt;/span&gt;];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; endpoint = configuration[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;AWS:S3:Endpoint&amp;#34;&lt;/span&gt;];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        _bucketName = configuration[&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;AWS:S3:BucketName&amp;#34;&lt;/span&gt;] 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                      ?? &lt;span style=&#34;color:#66d9ef&#34;&gt;throw&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; ArgumentNullException(nameof(configuration), &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;AWS:S3:BucketName is not configured&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; config = &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; AmazonS3Config { 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            ServiceURL = endpoint,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            SignatureVersion = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;4&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#75715e&#34;&gt;// 注意这里&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            ForcePathStyle = &lt;span style=&#34;color:#66d9ef&#34;&gt;true&lt;/span&gt;,  &lt;span style=&#34;color:#75715e&#34;&gt;// 重要！R2 需要这个配置&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            AuthenticationRegion = &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;auto&amp;#34;&lt;/span&gt;,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        };
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        _r2Client = &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; AmazonS3Client(accessKey, secretKey, config);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;public&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;async&lt;/span&gt; Task&amp;lt;(&lt;span style=&#34;color:#66d9ef&#34;&gt;string&lt;/span&gt; PresignedUrl, &lt;span style=&#34;color:#66d9ef&#34;&gt;string&lt;/span&gt; ImageUrl)&amp;gt; GeneratePresignedUrl(&lt;span style=&#34;color:#66d9ef&#34;&gt;string&lt;/span&gt; fileName, &lt;span style=&#34;color:#66d9ef&#34;&gt;string&lt;/span&gt; fileType)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; key = &lt;span style=&#34;color:#e6db74&#34;&gt;$&amp;#34;{Guid.NewGuid()}-{fileName}&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; request = &lt;span style=&#34;color:#66d9ef&#34;&gt;new&lt;/span&gt; GetPreSignedUrlRequest
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            BucketName = _bucketName,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            Key = key,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            Verb = HttpVerb.PUT, &lt;span style=&#34;color:#75715e&#34;&gt;// 请求的签名方法是PUT, 所以客户端上传文件时, 也必须使用PUT方法&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            ContentType = fileType,
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            Expires = DateTime.Now.AddMinutes(&lt;span style=&#34;color:#ae81ff&#34;&gt;50&lt;/span&gt;),
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        };
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; presignedUrl = &lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; _r2Client.GetPreSignedURLAsync(request);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;var&lt;/span&gt; imageUrl = &lt;span style=&#34;color:#e6db74&#34;&gt;$&amp;#34;{_r2Client.Config.ServiceURL}/{_bucketName}/{key}&amp;#34;&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt; (presignedUrl, imageUrl);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;前端代码:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-js&#34; data-lang=&#34;js&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;registerForm&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;addEventListener&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;submit&amp;#39;&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;async&lt;/span&gt; (&lt;span style=&#34;color:#a6e22e&#34;&gt;e&lt;/span&gt;) =&amp;gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    ...
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;file&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; document.&lt;span style=&#34;color:#a6e22e&#34;&gt;getElementById&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;profileImage&amp;#39;&lt;/span&gt;).&lt;span style=&#34;color:#a6e22e&#34;&gt;files&lt;/span&gt;[&lt;span style=&#34;color:#ae81ff&#34;&gt;0&lt;/span&gt;];
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; (&lt;span style=&#34;color:#a6e22e&#34;&gt;file&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;const&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;presignedUrlResponse&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;axios&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;get&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;API_URL&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;/api/auth/presigned-url`&lt;/span&gt;, {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#a6e22e&#34;&gt;params&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; { &lt;span style=&#34;color:#a6e22e&#34;&gt;fileName&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;file&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;name&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;fileType&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;file&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;type&lt;/span&gt; }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            });
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;const&lt;/span&gt; { &lt;span style=&#34;color:#a6e22e&#34;&gt;presignedUrl&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;imageUrl&lt;/span&gt; } &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;presignedUrlResponse&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;data&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#a6e22e&#34;&gt;console&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;log&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Received presigned URL:&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;presignedUrl&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#66d9ef&#34;&gt;try&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#75715e&#34;&gt;// 注意是PUT方法, 也包含了Content-Type头
&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;&lt;/span&gt;                &lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;axios&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;put&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;presignedUrl&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;file&lt;/span&gt;, {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                    &lt;span style=&#34;color:#a6e22e&#34;&gt;headers&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; {&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Content-Type&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;file&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;type&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                });
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#a6e22e&#34;&gt;userData&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;profileImage&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;imageUrl&lt;/span&gt;;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            } &lt;span style=&#34;color:#66d9ef&#34;&gt;catch&lt;/span&gt; (&lt;span style=&#34;color:#a6e22e&#34;&gt;uploadError&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#a6e22e&#34;&gt;console&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;error&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Error uploading image:&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;uploadError&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;                &lt;span style=&#34;color:#66d9ef&#34;&gt;return&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#66d9ef&#34;&gt;await&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;axios&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;post&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;`&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;${&lt;/span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;API_URL&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;}&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;/api/auth/register`&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;userData&lt;/span&gt;, {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;            &lt;span style=&#34;color:#a6e22e&#34;&gt;headers&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; {&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;Content-Type&amp;#39;&lt;/span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;:&lt;/span&gt; &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;application/json&amp;#39;&lt;/span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        });
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#a6e22e&#34;&gt;console&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;log&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;User registered successfully&amp;#34;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    } &lt;span style=&#34;color:#66d9ef&#34;&gt;catch&lt;/span&gt; (&lt;span style=&#34;color:#a6e22e&#34;&gt;error&lt;/span&gt;) {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#a6e22e&#34;&gt;console&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;error&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Registration error:&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;error&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#a6e22e&#34;&gt;handleAxiosError&lt;/span&gt;(&lt;span style=&#34;color:#a6e22e&#34;&gt;error&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#39;register&amp;#39;&lt;/span&gt;);
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;});
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;</content>
    </item>
    
    <item>
      <title>Cloudflare R2 配合 PicGo 博客图床</title>
      <link>https://blog.jiyi27.com/posts/build-website/011-cf-r2/</link>
      <pubDate>Sat, 06 Apr 2024 18:28:22 +0000</pubDate>
      
      <guid>https://blog.jiyi27.com/posts/build-website/011-cf-r2/</guid>
      <description>&lt;h2 id=&#34;r2-vs-s3&#34;&gt;R2 vs S3&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://www.cloudflare.com/en-ca/pg-cloudflare-r2-vs-aws-s3/&#34;&gt;Cloudflare R2 vs AWS S3 | Review Pricing &amp;amp; Features | Cloudflare&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;install-mc-minio-client&#34;&gt;Install mc (MinIO Client)&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# just install minio client not minio server&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;brew install minio/stable/mc
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mc alias set r2 R2-URL AccessKey SecretKey
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;The MinIO client provides identical commands to Unix file management commands, such as cp and ls, but is designed for both local and remote storage systems. It’s fully compatible with AWS S3.&lt;/p&gt;</description>
      <content>&lt;h2 id=&#34;r2-vs-s3&#34;&gt;R2 vs S3&lt;/h2&gt;
&lt;p&gt;&lt;a href=&#34;https://www.cloudflare.com/en-ca/pg-cloudflare-r2-vs-aws-s3/&#34;&gt;Cloudflare R2 vs AWS S3 | Review Pricing &amp;amp; Features | Cloudflare&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;install-mc-minio-client&#34;&gt;Install mc (MinIO Client)&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#75715e&#34;&gt;# just install minio client not minio server&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;brew install minio/stable/mc
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mc alias set r2 R2-URL AccessKey SecretKey
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;The MinIO client provides identical commands to Unix file management commands, such as cp and ls, but is designed for both local and remote storage systems. It’s fully compatible with AWS S3.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&#34;common-commands&#34;&gt;Common Commands&lt;/h2&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mc ls &amp;lt;ALIAS&amp;gt;/&amp;lt;BucketName&amp;gt;: List all objects in a bucket.
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mc cp -r &amp;lt;LOCAL-FOLDER-PATH&amp;gt; &amp;lt;ALIAS&amp;gt;/&amp;lt;BUCKET&amp;gt;/&amp;lt;REMOTE-FOLDER-PATH&amp;gt;: Upload a folder to a bucket.
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;mc rm &amp;lt;ALIAS&amp;gt;/&amp;lt;BUCKET&amp;gt;/&amp;lt;OBJECT&amp;gt;: Remove an object.
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;h2 id=&#34;picgo-with-r2&#34;&gt;PicGo with R2&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/Molunerfinn/PicGo/blob/dev/FAQ.md&#34;&gt;macOS系统安装完PicGo显示文件已损坏&lt;/a&gt;, 因为 PicGo 没有签名，所以会被 macOS 的安全检查所拦下&lt;/p&gt;
&lt;p&gt;sudo spctl &amp;ndash;master-disable&lt;/p&gt;
&lt;p&gt;xattr -cr /Applications/PicGo.app&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;You need install a S3 plugin to use R2 as a storage service.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/04/e399e522056aea831f766a9c504e8fbc.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;Here is how to configure S3:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/12/b6faab4bf8f103cff2ed78bc49bdf3af.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/12/c794d2642308eec851e89c93c3ab4af8.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/12/da7ee320e2aa8909611a123a40a32f85.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://github.com/Molunerfinn/PicGo/releases&#34;&gt;Releases · Molunerfinn/PicGo&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;MacOS cannot open the app because it is from an unidentified developer, check the &lt;a href=&#34;https://github.com/Molunerfinn/PicGo/blob/dev/FAQ.md&#34;&gt;solution&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;a href=&#34;https://blog.huacai.one/post/3#%E5%AE%89%E8%A3%85S3%E6%8F%92%E4%BB%B6&#34;&gt;CloudFlare R2搭建个人图床&lt;/a&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;presigned-url&#34;&gt;Presigned URL&lt;/h2&gt;
&lt;blockquote&gt;
&lt;p&gt;Presigned URLs can only be used with the &lt;code&gt;&amp;lt;accountid&amp;gt;.r2.cloudflarestorage.com&lt;/code&gt; S3 API domain and cannot be used with custom domains. &lt;a href=&#34;https://arc.net/l/quote/wbihytnh&#34;&gt;https://arc.net/l/quote/wbihytnh&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/09/db50e9e969862912f556267f81985439.jpg&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
</content>
    </item>
    
    <item>
      <title>Wget Connecting Timeout Issue</title>
      <link>https://blog.jiyi27.com/posts/build-website/010-wget-connecting-timeout/</link>
      <pubDate>Fri, 29 Mar 2024 20:28:22 +0000</pubDate>
      
      <guid>https://blog.jiyi27.com/posts/build-website/010-wget-connecting-timeout/</guid>
      <description>&lt;h2 id=&#34;1-issue&#34;&gt;1. Issue&lt;/h2&gt;
&lt;p&gt;When I use &lt;code&gt;wget&lt;/code&gt; to download some files, I got the following error:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$sh -c &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Connecting to raw.githubusercontent.com &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;raw.githubusercontent.com&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;|2606:50c0:8002::154|:443...
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You can use &lt;code&gt;curl&lt;/code&gt; to replace &lt;code&gt;wget&lt;/code&gt;, or you can get the ip address of the domain and add it to &lt;code&gt;/etc/hosts&lt;/code&gt; file.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;185.199.108.133 raw.githubusercontent.com
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You can find the ip address with &lt;code&gt;dig/ping&lt;/code&gt; command or on the some online tool website. ping probably won&amp;rsquo;t work.&lt;/p&gt;</description>
      <content>&lt;h2 id=&#34;1-issue&#34;&gt;1. Issue&lt;/h2&gt;
&lt;p&gt;When I use &lt;code&gt;wget&lt;/code&gt; to download some files, I got the following error:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;$sh -c &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;$(&lt;/span&gt;wget https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh -O -&lt;span style=&#34;color:#66d9ef&#34;&gt;)&lt;/span&gt;&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Connecting to raw.githubusercontent.com &lt;span style=&#34;color:#f92672&#34;&gt;(&lt;/span&gt;raw.githubusercontent.com&lt;span style=&#34;color:#f92672&#34;&gt;)&lt;/span&gt;|2606:50c0:8002::154|:443...
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You can use &lt;code&gt;curl&lt;/code&gt; to replace &lt;code&gt;wget&lt;/code&gt;, or you can get the ip address of the domain and add it to &lt;code&gt;/etc/hosts&lt;/code&gt; file.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;185.199.108.133 raw.githubusercontent.com
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;You can find the ip address with &lt;code&gt;dig/ping&lt;/code&gt; command or on the some online tool website. ping probably won&amp;rsquo;t work.&lt;/p&gt;
</content>
    </item>
    
    <item>
      <title>Go File Server Cannot Handle Large Files</title>
      <link>https://blog.jiyi27.com/posts/bugs/009-go-server-handle-large-file/</link>
      <pubDate>Thu, 30 Nov 2023 21:43:22 +0000</pubDate>
      
      <guid>https://blog.jiyi27.com/posts/bugs/009-go-server-handle-large-file/</guid>
      <description>&lt;h2 id=&#34;1-problem-description&#34;&gt;1. Problem description&lt;/h2&gt;
&lt;p&gt;I&amp;rsquo;ve discussed how to use Cloudflare as a &lt;a href=&#34;https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/&#34;&gt;reverse proxy&lt;/a&gt; for my web traffic in &lt;a href=&#34;https://blog.yorforger.cc/post/build-website/008-cloudflare-cdn/&#34;&gt;previous post&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I write a &lt;a href=&#34;https://github.com/shwezhu/file-server&#34;&gt;file server&lt;/a&gt; in Go, when attempting to upload a file of approximately 200 MB, it becomes very slow (always uploading) and never succeed. Upon monitoring the server using tools like &lt;code&gt;htop&lt;/code&gt;, it seems that the server might be unaware of the incoming large file upload. I come across a error by chance:  &lt;strong&gt;413 Request Entity Too Large&lt;/strong&gt;.&lt;/p&gt;</description>
      <content>&lt;h2 id=&#34;1-problem-description&#34;&gt;1. Problem description&lt;/h2&gt;
&lt;p&gt;I&amp;rsquo;ve discussed how to use Cloudflare as a &lt;a href=&#34;https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/&#34;&gt;reverse proxy&lt;/a&gt; for my web traffic in &lt;a href=&#34;https://blog.yorforger.cc/post/build-website/008-cloudflare-cdn/&#34;&gt;previous post&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I write a &lt;a href=&#34;https://github.com/shwezhu/file-server&#34;&gt;file server&lt;/a&gt; in Go, when attempting to upload a file of approximately 200 MB, it becomes very slow (always uploading) and never succeed. Upon monitoring the server using tools like &lt;code&gt;htop&lt;/code&gt;, it seems that the server might be unaware of the incoming large file upload. I come across a error by chance:  &lt;strong&gt;413 Request Entity Too Large&lt;/strong&gt;.&lt;/p&gt;
&lt;h2 id=&#34;2-cloudflare&#34;&gt;2. Cloudflare&lt;/h2&gt;
&lt;p&gt;Then I found this is because the limitation of Couldflare proxy:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;There’s a &lt;strong&gt;body size&lt;/strong&gt; limit of 100 MB on Free and Pro, 200 MB on Business and &lt;a href=&#34;https://community.cloudflare.com/t/community-tip-fixing-error-500-internal-server-error/44453&#34;&gt;50074&lt;/a&gt; MB on Enterprise. Only Enterprise customers can request to have the body size limit increased.&lt;/p&gt;
&lt;p&gt;Each user can only upload files with maximum size of 100MB at a time &lt;strong&gt;if your website is proxied by Cloudflare.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://community.cloudflare.com/t/does-the-100-mb-limit-apllies-to-all-users-on-my-website/297261&#34;&gt;Does the 100 Mb limit apllies to all users on my website?&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;So this is the thing, then I try to access my website directly by IP address (bypass the Cloudflare proxy).&lt;/p&gt;
&lt;h2 id=&#34;3-vps-ram&#34;&gt;3. VPS RAM&lt;/h2&gt;
&lt;p&gt;Then I can see my file server handling the incoming request whose body larger than 100MB, I use &lt;code&gt;htop&lt;/code&gt; to check the RAM usage status on my VPS, I can see the RAM increase from 50MB to 100MB then 200MB, then my file server get killed by the OS.&lt;/p&gt;
&lt;p&gt;My VPS RAM is 512MB, and there is 460MB left, I don&amp;rsquo;t know why the OS kill my file server program.&lt;/p&gt;
&lt;h2 id=&#34;4-golang&#34;&gt;4. Golang&lt;/h2&gt;
&lt;p&gt;Besides, when I tried to upload some files whose size is around 60MB, the RAM usage of my VPS increase from 50MB (total) to around 100MB, this makes sense, because the file server needs load the whole file to the RAM and copy the content to the disk.&lt;/p&gt;
&lt;p&gt;But after handling this request, the RAM usage is still around 100MB, if I upload another file (60MB), then the RAM usage increases to around 160MB. I thought there is memory leak on my program. But I was wrong. I found a post and share it here:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Go does not release memory it allocated from the OS immediately. The reason is probably that allocating memory is costly (needs system calls) and the chance is high that it will be needed in the near future anyway again. But, if memory gets long enough unused it will be released eventually so that the &lt;strong&gt;RSS&lt;/strong&gt; of the process decreases again.&lt;/p&gt;
&lt;p&gt;Learn more: &lt;a href=&#34;https://stackoverflow.com/a/49843380/16317008&#34;&gt;https://stackoverflow.com/a/49843380/16317008&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;blockquote&gt;
&lt;p&gt;RSS indicates the actual physical memory consumed by a process, while VSZ includes not only the physical memory but also the virtual memory.&lt;/p&gt;
&lt;p&gt;Learn more: &lt;a href=&#34;https://stackoverflow.com/a/21049737/16317008&#34;&gt;https://stackoverflow.com/a/21049737/16317008&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
</content>
    </item>
    
    <item>
      <title>Get Free TLS certificate with Cloudflare</title>
      <link>https://blog.jiyi27.com/posts/build-website/008-cloudflare-cdn/</link>
      <pubDate>Wed, 15 Nov 2023 20:09:22 +0000</pubDate>
      
      <guid>https://blog.jiyi27.com/posts/build-website/008-cloudflare-cdn/</guid>
      <description>&lt;h2 id=&#34;1-hosting-your-domain-on-cloudflare-enable-cdn&#34;&gt;1. Hosting your domain on Cloudflare (Enable CDN)&lt;/h2&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;client &amp;lt;----tls-1----&amp;gt; cloudflare &amp;lt;----tls-2----&amp;gt; your server
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; You cannot login your server with &lt;code&gt;ssh user@your_domain&lt;/code&gt; any more after enabling Cloudflare. You need to login with &lt;code&gt;ssh user@your_ip&lt;/code&gt;. Cause the Cloudflare acts as a reverse proxy, it only forwards the http/https traffic to your server, and &lt;a href=&#34;https://developers.cloudflare.com/fundamentals/reference/network-ports/&#34;&gt;only on some specific ports&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;There are two steps to add your domain to Cloudflare:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Add your domain to Cloudflare&lt;/li&gt;
&lt;li&gt;Create and install TLS certificate to your server&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;Cloudflare does this by serving as a &lt;a href=&#34;https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/&#34;&gt;reverse proxy&lt;/a&gt; for your web traffic. Actually, Clooudflare achieves this by using its CDN service, which caches your website&amp;rsquo;s static content and serves it to your visitors from the nearest Cloudflare data center.
Refer to our Load Balancing reference architecture to learn more about advanced ways to forward traffic to your origins, as well as our &lt;a href=&#34;https://developers.cloudflare.com/reference-architecture/architectures/cdn/&#34;&gt;CDN reference architecture&lt;/a&gt; to learn more about how Cloudflare processes and optimizes your web traffic.&lt;/p&gt;</description>
      <content>&lt;h2 id=&#34;1-hosting-your-domain-on-cloudflare-enable-cdn&#34;&gt;1. Hosting your domain on Cloudflare (Enable CDN)&lt;/h2&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;client &amp;lt;----tls-1----&amp;gt; cloudflare &amp;lt;----tls-2----&amp;gt; your server
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; You cannot login your server with &lt;code&gt;ssh user@your_domain&lt;/code&gt; any more after enabling Cloudflare. You need to login with &lt;code&gt;ssh user@your_ip&lt;/code&gt;. Cause the Cloudflare acts as a reverse proxy, it only forwards the http/https traffic to your server, and &lt;a href=&#34;https://developers.cloudflare.com/fundamentals/reference/network-ports/&#34;&gt;only on some specific ports&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;There are two steps to add your domain to Cloudflare:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Add your domain to Cloudflare&lt;/li&gt;
&lt;li&gt;Create and install TLS certificate to your server&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;Cloudflare does this by serving as a &lt;a href=&#34;https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/&#34;&gt;reverse proxy&lt;/a&gt; for your web traffic. Actually, Clooudflare achieves this by using its CDN service, which caches your website&amp;rsquo;s static content and serves it to your visitors from the nearest Cloudflare data center.
Refer to our Load Balancing reference architecture to learn more about advanced ways to forward traffic to your origins, as well as our &lt;a href=&#34;https://developers.cloudflare.com/reference-architecture/architectures/cdn/&#34;&gt;CDN reference architecture&lt;/a&gt; to learn more about how Cloudflare processes and optimizes your web traffic.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;11-add-your-domain-to-cloudflare&#34;&gt;1.1. Add your domain to Cloudflare&lt;/h3&gt;
&lt;p&gt;Go to this website: &lt;a href=&#34;https://dash.cloudflare.com/&#34;&gt;https://dash.cloudflare.com/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/5ec8185791f488d73320ceadd0db79dc.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;And you will get instructions for updating your nameserver of your domain. After change your nameserver, waite about one hour, your site will be &lt;strong&gt;active&lt;/strong&gt; on Cloudflare. Then you can choose the TLS encryption mode:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/3ff225afee4374761c3943c1c6ed009a.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; choose &lt;code&gt;full mode&lt;/code&gt;, don&amp;rsquo;t use &lt;code&gt;flexbile mode&lt;/code&gt;, otherwise you &lt;strong&gt;probably would&lt;/strong&gt; get &lt;a href=&#34;https://developers.cloudflare.com/ssl/troubleshooting/too-many-redirects/&#34;&gt;ERR_TOO_MANY_REDIRECTS&lt;/a&gt; when access your website.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;12-install-tls-certificate&#34;&gt;1.2. Install TLS certificate&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/d3d8aa4e52defcc7961fe8fad4d3eb88.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;The generated two files &lt;code&gt;cert.pem&lt;/code&gt; and &lt;code&gt;cert.key&lt;/code&gt; is used for encryption between your server and Cloudflare.&lt;/p&gt;
&lt;p&gt;You can use these two file like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;main&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;http&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;HandleFunc&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/hello&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;HelloServer&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;http&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;ListenAndServeTLS&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;:443&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./conf/cert.pem&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./conf/cert.key&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#a6e22e&#34;&gt;log&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Fatal&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ListenAndServe: &amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: don&amp;rsquo;t add the keep-alive header when handle request on your server, otherwise you may get a 520 error when you access your website on browser: &lt;code&gt;Error 520: Web server is returning an unknown error&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;w&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Header&lt;/span&gt;().&lt;span style=&#34;color:#a6e22e&#34;&gt;Set&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Connection&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Keep-Alive&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;w&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Header&lt;/span&gt;().&lt;span style=&#34;color:#a6e22e&#34;&gt;Set&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Keep-Alive&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;timeout=2, max=1000&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Learn more: &lt;a href=&#34;https://luyuhuang.tech/2020/06/03/cloudflare-free-https.html&#34;&gt;https://luyuhuang.tech/2020/06/03/cloudflare-free-https.html&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;After config this, the DNS needs time to take effect (you change the nameservers of your domain to Cloudfalre from the defatult nameservers, this needs time to take effect)&lt;/p&gt;
&lt;p&gt;If there still no HTTPS connection but the cloudflare displays your website &lt;strong&gt;is active&lt;/strong&gt; on their service, you may try to check if your server is listening on 443 port and try to flush the DNS cache of your client computer (chrome + system DNS cache). Learn more: &lt;a href=&#34;https://davidzhu.xyz/post/networking/002-dns-basics/&#34;&gt;DNS Concepts (NameServer(NS), DNS Records and Caching) - David&amp;rsquo;s Blog&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;BTW, you can check if your domain is proxied by the Cloudflare with nslookup command, which will get the &lt;code&gt;A Record&lt;/code&gt; by default (IPv4) address of your domain, but in this case, with Cloudfalre proxy, you should get the ip of Cloudfalre Name Server.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;❯ nslookup shaowenzhu.top
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Non-authoritative answer:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Name:	shaowenzhu.top
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Address: 172.67.171.207 &lt;span style=&#34;color:#75715e&#34;&gt;# not my domain&amp;#39;s real ip, it&amp;#39;s Cloudfalre&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Name:	shaowenzhu.top
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Address: 104.21.47.185 &lt;span style=&#34;color:#75715e&#34;&gt;# not my domain&amp;#39;s real ip, it&amp;#39;s Cloudfalre&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Learn more: &lt;a href=&#34;https://developers.cloudflare.com/fundamentals/setup/account-setup/add-site/&#34;&gt;Add a site · Cloudflare Fundamentals docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;2-change-a-record&#34;&gt;2. Change A record&lt;/h2&gt;
&lt;p&gt;If you changed a vps, all you need to do is to change the A record of your domain on Cloudflare, you don&amp;rsquo;t need to change the A record on your domain register website.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Cloudflare serves as a &lt;strong&gt;reverse proxy&lt;/strong&gt;, directing all traffic for the specified proxied domain to the target IP address.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/af17da33f67f363301b8d14cf87428ea.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;3-allow-custom-port&#34;&gt;3. Allow custom port&lt;/h2&gt;
&lt;p&gt;The default port of https is 443. If you want to use other ports, you need to allow them with firewall first on your server.&lt;/p&gt;
&lt;p&gt;Cloudflare only allows the following &lt;strong&gt;HTTPS&lt;/strong&gt; ports:&lt;/p&gt;
&lt;p&gt;443
2053
2083
2087
2096
8443&lt;/p&gt;
&lt;p&gt;Very easy, you don&amp;rsquo;t need to do anything on Cloudflare, just allow the port on your server. Then you can access your website with &lt;code&gt;https://your_domain:port&lt;/code&gt;. And your traffic will be encrypted by Cloudflare.&lt;/p&gt;
&lt;p&gt;Learn more:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://community.cloudflare.com/t/how-to-allow-custom-port/175855&#34;&gt;How to allow custom port - Website, Application, Performance / Security - Cloudflare Community&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://developers.cloudflare.com/fundamentals/reference/network-ports/&#34;&gt;Network ports · Cloudflare Fundamentals docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Learn more about CDN:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.cloudflare.com/learning/cdn/what-is-a-cdn/&#34;&gt;What is a content delivery network (CDN)? | How do CDNs work? | Cloudflare&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://developers.cloudflare.com/reference-architecture/architectures/cdn/&#34;&gt;Reference Architecture: Cloudflare Content Delivery Network (CDN) · Cloudflare Reference Architecture docs&lt;/a&gt;&lt;/p&gt;
</content>
    </item>
    
  </channel>
</rss>
