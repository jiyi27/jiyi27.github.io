<!DOCTYPE html>
<html lang="en">
<head>
  
    
    <title>Get Free TLS certificate with Cloudflare :: 为霜的博客</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="1. Hosting your domain on Cloudflare (Enable CDN) client &lt;----tls-1----&gt; cloudflare &lt;----tls-2----&gt; your server Note: You cannot login your server with ssh user@your_domain any more after enabling Cloudflare. You need to login with ssh user@your_ip. Cause the Cloudflare acts as a reverse proxy, it only forwards the http/https traffic to your server, and only on some specific ports.
There are two steps to add your domain to Cloudflare:
Add your domain to Cloudflare Create and install TLS certificate to your server Cloudflare does this by serving as a reverse proxy for your web traffic. Actually, Clooudflare achieves this by using its CDN service, which caches your website&rsquo;s static content and serves it to your visitors from the nearest Cloudflare data center. Refer to our Load Balancing reference architecture to learn more about advanced ways to forward traffic to your origins, as well as our CDN reference architecture to learn more about how Cloudflare processes and optimizes your web traffic.
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://blog.jiyi27.com/posts/build-website/008-cloudflare-cdn/" />





  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/categories.min.3202f75cbb294747099af3850a68a09ee94b3ce505fc39e134692d90ff0a9b2a.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/code.min.dd73d157e77e82a3dc1cb06ba424cf6cc6811af0bb604ad6c68e70faf2439c8a.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/main.min.3fb8954e26342ad3afabb4525959bfec6f9fc0d6929f0dda738ddeee30211690.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/menu.min.8cee75f73b9f9b1e40bd0dd53e6e770156b08bbfe1c579cd256c3f6cd3b6d32b.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/post.min.014a50745fbdd41d5f420a3e288730d5af4b7d90344dc6211d0e50c368b5b303.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/prism.min.b958d3d7c6c67361b945f9062d07d403422604b3d2cd33f93b88d41ed0ba634d.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/term.min.94de320c1b850e126e6d2c88a7c90acf58bb1313f0ea14a14cda2a42f2a88db2.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="https://blog.jiyi27.com/terminal.css">




<link rel="shortcut icon" href="https://blog.jiyi27.com/favicon.png">
<link rel="apple-touch-icon" href="https://blog.jiyi27.com/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Get Free TLS certificate with Cloudflare">
<meta property="og:description" content="1. Hosting your domain on Cloudflare (Enable CDN) client &lt;----tls-1----&gt; cloudflare &lt;----tls-2----&gt; your server Note: You cannot login your server with ssh user@your_domain any more after enabling Cloudflare. You need to login with ssh user@your_ip. Cause the Cloudflare acts as a reverse proxy, it only forwards the http/https traffic to your server, and only on some specific ports.
There are two steps to add your domain to Cloudflare:
Add your domain to Cloudflare Create and install TLS certificate to your server Cloudflare does this by serving as a reverse proxy for your web traffic. Actually, Clooudflare achieves this by using its CDN service, which caches your website&rsquo;s static content and serves it to your visitors from the nearest Cloudflare data center. Refer to our Load Balancing reference architecture to learn more about advanced ways to forward traffic to your origins, as well as our CDN reference architecture to learn more about how Cloudflare processes and optimizes your web traffic.
" />
<meta property="og:url" content="https://blog.jiyi27.com/posts/build-website/008-cloudflare-cdn/" />
<meta property="og:site_name" content="为霜的博客" />

  <meta property="og:image" content="https://blog.jiyi27.com/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">

  <meta property="article:section" content="建站" />


  <meta property="article:published_time" content="2023-11-15 20:09:22 &#43;0000 UTC" />












</head>
<body>


<div class="container center">

  
  
  

  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.jiyi27.com/posts/build-website/008-cloudflare-cdn/">Get Free TLS certificate with Cloudflare</a>
  </h1>
  <div class="post-meta"><time class="post-date">2023-11-15</time><span class="post-reading-time">4 分钟阅读 (669 字数)</span></div>

  
    <span class="post-tags">
      
      #<a href="https://blog.jiyi27.com/tags/%E5%BB%BA%E7%AB%99/">建站</a>&nbsp;
      
      #<a href="https://blog.jiyi27.com/tags/cloudflare/">cloudflare</a>&nbsp;
      
      #<a href="https://blog.jiyi27.com/tags/cdn/">cdn</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <h2 id="1-hosting-your-domain-on-cloudflare-enable-cdn">1. Hosting your domain on Cloudflare (Enable CDN)<a href="#1-hosting-your-domain-on-cloudflare-enable-cdn" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<pre tabindex="0"><code>client &lt;----tls-1----&gt; cloudflare &lt;----tls-2----&gt; your server
</code></pre><blockquote>
<p><strong>Note:</strong> You cannot login your server with <code>ssh user@your_domain</code> any more after enabling Cloudflare. You need to login with <code>ssh user@your_ip</code>. Cause the Cloudflare acts as a reverse proxy, it only forwards the http/https traffic to your server, and <a href="https://developers.cloudflare.com/fundamentals/reference/network-ports/">only on some specific ports</a>.</p>
</blockquote>
<p>There are two steps to add your domain to Cloudflare:</p>
<ul>
<li>Add your domain to Cloudflare</li>
<li>Create and install TLS certificate to your server</li>
</ul>
<blockquote>
<p>Cloudflare does this by serving as a <a href="https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/">reverse proxy</a> for your web traffic. Actually, Clooudflare achieves this by using its CDN service, which caches your website&rsquo;s static content and serves it to your visitors from the nearest Cloudflare data center.
Refer to our Load Balancing reference architecture to learn more about advanced ways to forward traffic to your origins, as well as our <a href="https://developers.cloudflare.com/reference-architecture/architectures/cdn/">CDN reference architecture</a> to learn more about how Cloudflare processes and optimizes your web traffic.</p>
</blockquote>
<h3 id="11-add-your-domain-to-cloudflare">1.1. Add your domain to Cloudflare<a href="#11-add-your-domain-to-cloudflare" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Go to this website: <a href="https://dash.cloudflare.com/">https://dash.cloudflare.com/</a></p>
<p><img src="https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/5ec8185791f488d73320ceadd0db79dc.png" alt=""></p>
<p>And you will get instructions for updating your nameserver of your domain. After change your nameserver, waite about one hour, your site will be <strong>active</strong> on Cloudflare. Then you can choose the TLS encryption mode:</p>
<p><img src="https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/3ff225afee4374761c3943c1c6ed009a.png" alt=""></p>
<blockquote>
<p><strong>Note:</strong> choose <code>full mode</code>, don&rsquo;t use <code>flexbile mode</code>, otherwise you <strong>probably would</strong> get <a href="https://developers.cloudflare.com/ssl/troubleshooting/too-many-redirects/">ERR_TOO_MANY_REDIRECTS</a> when access your website.</p>
</blockquote>
<h3 id="12-install-tls-certificate">1.2. Install TLS certificate<a href="#12-install-tls-certificate" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p><img src="https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/d3d8aa4e52defcc7961fe8fad4d3eb88.png" alt=""></p>
<p>The generated two files <code>cert.pem</code> and <code>cert.key</code> is used for encryption between your server and Cloudflare.</p>
<p>You can use these two file like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">...</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>, <span style="color:#a6e22e">HelloServer</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServeTLS</span>(<span style="color:#e6db74">&#34;:443&#34;</span>, <span style="color:#e6db74">&#34;./conf/cert.pem&#34;</span>, <span style="color:#e6db74">&#34;./conf/cert.key&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#e6db74">&#34;ListenAndServe: &#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p><strong>Note</strong>: don&rsquo;t add the keep-alive header when handle request on your server, otherwise you may get a 520 error when you access your website on browser: <code>Error 520: Web server is returning an unknown error</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Connection&#34;</span>, <span style="color:#e6db74">&#34;Keep-Alive&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Header</span>().<span style="color:#a6e22e">Set</span>(<span style="color:#e6db74">&#34;Keep-Alive&#34;</span>, <span style="color:#e6db74">&#34;timeout=2, max=1000&#34;</span>)
</span></span></code></pre></div></blockquote>
<p>Learn more: <a href="https://luyuhuang.tech/2020/06/03/cloudflare-free-https.html">https://luyuhuang.tech/2020/06/03/cloudflare-free-https.html</a></p>
<blockquote>
<p>After config this, the DNS needs time to take effect (you change the nameservers of your domain to Cloudfalre from the defatult nameservers, this needs time to take effect)</p>
<p>If there still no HTTPS connection but the cloudflare displays your website <strong>is active</strong> on their service, you may try to check if your server is listening on 443 port and try to flush the DNS cache of your client computer (chrome + system DNS cache). Learn more: <a href="https://davidzhu.xyz/post/networking/002-dns-basics/">DNS Concepts (NameServer(NS), DNS Records and Caching) - David&rsquo;s Blog</a></p>
</blockquote>
<p>BTW, you can check if your domain is proxied by the Cloudflare with nslookup command, which will get the <code>A Record</code> by default (IPv4) address of your domain, but in this case, with Cloudfalre proxy, you should get the ip of Cloudfalre Name Server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>❯ nslookup shaowenzhu.top
</span></span><span style="display:flex;"><span>Non-authoritative answer:
</span></span><span style="display:flex;"><span>Name:	shaowenzhu.top
</span></span><span style="display:flex;"><span>Address: 172.67.171.207 <span style="color:#75715e"># not my domain&#39;s real ip, it&#39;s Cloudfalre</span>
</span></span><span style="display:flex;"><span>Name:	shaowenzhu.top
</span></span><span style="display:flex;"><span>Address: 104.21.47.185 <span style="color:#75715e"># not my domain&#39;s real ip, it&#39;s Cloudfalre</span>
</span></span></code></pre></div><p>Learn more: <a href="https://developers.cloudflare.com/fundamentals/setup/account-setup/add-site/">Add a site · Cloudflare Fundamentals docs</a></p>
<h2 id="2-change-a-record">2. Change A record<a href="#2-change-a-record" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>If you changed a vps, all you need to do is to change the A record of your domain on Cloudflare, you don&rsquo;t need to change the A record on your domain register website.</p>
<blockquote>
<p>Cloudflare serves as a <strong>reverse proxy</strong>, directing all traffic for the specified proxied domain to the target IP address.</p>
</blockquote>
<p><img src="https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/af17da33f67f363301b8d14cf87428ea.png" alt=""></p>
<h2 id="3-allow-custom-port">3. Allow custom port<a href="#3-allow-custom-port" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>The default port of https is 443. If you want to use other ports, you need to allow them with firewall first on your server.</p>
<p>Cloudflare only allows the following <strong>HTTPS</strong> ports:</p>
<p>443
2053
2083
2087
2096
8443</p>
<p>Very easy, you don&rsquo;t need to do anything on Cloudflare, just allow the port on your server. Then you can access your website with <code>https://your_domain:port</code>. And your traffic will be encrypted by Cloudflare.</p>
<p>Learn more:</p>
<p><a href="https://community.cloudflare.com/t/how-to-allow-custom-port/175855">How to allow custom port - Website, Application, Performance / Security - Cloudflare Community</a></p>
<p><a href="https://developers.cloudflare.com/fundamentals/reference/network-ports/">Network ports · Cloudflare Fundamentals docs</a></p>
<p>Learn more about CDN:</p>
<p><a href="https://www.cloudflare.com/learning/cdn/what-is-a-cdn/">What is a content delivery network (CDN)? | How do CDNs work? | Cloudflare</a></p>
<p><a href="https://developers.cloudflare.com/reference-architecture/architectures/cdn/">Reference Architecture: Cloudflare Content Delivery Network (CDN) · Cloudflare Reference Architecture docs</a></p>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">查看其他文章</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="https://blog.jiyi27.com/posts/networking/008-mpls/" class="button inline prev">
        MPLS
      </a>
    
    
      ::
    
    
      <a href="https://blog.jiyi27.com/posts/python/basics/001-virtual-environment/" class="button inline next">
        Python 虚拟环境 Conda Venv
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/jiyi27/jiyi27.github.io" target="_blank">Theme</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
