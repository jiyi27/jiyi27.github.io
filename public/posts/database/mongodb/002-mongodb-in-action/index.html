<!DOCTYPE html>
<html lang="en">
<head>
  
    
    <title>MongoDB in Action Reading Note :: 为霜的博客</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="1. Basic Theory MongoDB stores its information in documents rather than rows. Where relational databases have tables, MongoDB has collections.
Every MongoDB document requires an _id, and if one isn’t present when the document is created, a special MongoDB ObjectID will be generated and added to the document at that time. You can set your own _id by setting it in the document you insert, the ObjectID is just MongoDB’s default.
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://blog.jiyi27.com/posts/database/mongodb/002-mongodb-in-action/" />





  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/categories.min.3202f75cbb294747099af3850a68a09ee94b3ce505fc39e134692d90ff0a9b2a.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/code.min.dd73d157e77e82a3dc1cb06ba424cf6cc6811af0bb604ad6c68e70faf2439c8a.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/main.min.3fb8954e26342ad3afabb4525959bfec6f9fc0d6929f0dda738ddeee30211690.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/menu.min.8cee75f73b9f9b1e40bd0dd53e6e770156b08bbfe1c579cd256c3f6cd3b6d32b.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/post.min.014a50745fbdd41d5f420a3e288730d5af4b7d90344dc6211d0e50c368b5b303.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/prism.min.b958d3d7c6c67361b945f9062d07d403422604b3d2cd33f93b88d41ed0ba634d.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/term.min.94de320c1b850e126e6d2c88a7c90acf58bb1313f0ea14a14cda2a42f2a88db2.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="https://blog.jiyi27.com/terminal.css">




<link rel="shortcut icon" href="https://blog.jiyi27.com/favicon.png">
<link rel="apple-touch-icon" href="https://blog.jiyi27.com/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="MongoDB in Action Reading Note">
<meta property="og:description" content="1. Basic Theory MongoDB stores its information in documents rather than rows. Where relational databases have tables, MongoDB has collections.
Every MongoDB document requires an _id, and if one isn’t present when the document is created, a special MongoDB ObjectID will be generated and added to the document at that time. You can set your own _id by setting it in the document you insert, the ObjectID is just MongoDB’s default.
" />
<meta property="og:url" content="https://blog.jiyi27.com/posts/database/mongodb/002-mongodb-in-action/" />
<meta property="og:site_name" content="为霜的博客" />

  <meta property="og:image" content="https://blog.jiyi27.com/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">

  <meta property="article:section" content="数据库" />


  <meta property="article:published_time" content="2024-04-24 18:29:30 &#43;0000 UTC" />












</head>
<body>


<div class="container center">

  
  
  

  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.jiyi27.com/posts/database/mongodb/002-mongodb-in-action/">MongoDB in Action Reading Note</a>
  </h1>
  <div class="post-meta"><time class="post-date">2024-04-24</time><span class="post-reading-time">8 分钟阅读 (1554 字数)</span></div>

  
    <span class="post-tags">
      
      #<a href="https://blog.jiyi27.com/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>&nbsp;
      
      #<a href="https://blog.jiyi27.com/tags/%E8%AF%BB%E4%B9%A6/">读书</a>&nbsp;
      
      #<a href="https://blog.jiyi27.com/tags/mongodb/">mongodb</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <h2 id="1-basic-theory">1. Basic Theory<a href="#1-basic-theory" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>MongoDB stores its information in <strong>documents</strong> rather than <strong>rows</strong>. Where relational databases have <strong>tables</strong>, MongoDB has <em><strong>collections</strong></em>.</p>
<p>Every MongoDB document requires an <code>_id</code>, and if one isn’t present when the document is created, a special MongoDB ObjectID will be generated and added to the document at that time. You can set your own <code>_id</code> by setting it in the document you insert, the ObjectID is just MongoDB’s default.</p>
<p>Indexes don’t come for free; they take up some space and can make your inserts slightly more expensive, but they are an essential tool for query optimization.</p>
<p>MongoDB store documents in a collection in no particular order. To get documents in a particular order, you must can use the <code>sort()</code> method or the <code>$sort</code> aggregation pipeline stage. Learn more: <a href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-natural-order">natural order — MongoDB Manual</a></p>
<p>关于 foreign key 的概念常出现在 one to many 关系中, 比如评论表和用户, 一个用户可以有多个评论, 但一个评论只能有一个用户. 在传统数据库中, 评论表中会有一个 <code>user_id</code> 字段, 我们叫它外键, 每次查询时可以通过 join 操作将用户信息和评论信息关联起来 (即获取写了这个评论的用户具体信息和评论的具体内容).</p>
<p>MongoDB 没有传统数据库中 join 操作和 foreign key, 但可以通过 <a href="https://www.mongodb.com/docs/manual/data-modeling/concepts/embedding-vs-references/#embedded-data-models">embedded documents</a> 或者 <a href="https://www.mongodb.com/docs/manual/data-modeling/concepts/embedding-vs-references/#std-label-data-modeling-referencing">reference</a> 来表示一对多关系, 也可使用聚合来实现类似 Join 的功能. 具体官方文档有解释: <a href="https://www.mongodb.com/docs/manual/tutorial/model-embedded-one-to-many-relationships-between-documents/">Model One-to-Many Relationships with Embedded Documents</a>, <a href="https://www.mongodb.com/docs/manual/tutorial/model-referenced-one-to-many-relationships-between-documents/">Model One-to-Many Relationships with Document References</a></p>
<p>关于一对多, 多对多关系参考: <a href="https://www.youtube.com/watch?v=4q-keGvUnag">SQL Server Tutorial - One-to-many and many-to-many table relationships</a></p>
<p>关于外键请参考: <a href="https://www.youtube.com/watch?v=UQK9_gKQHZg">Learning MySQL - FOREIGN KEY CONSTRAINTS</a></p>
<p>关于 join 操作请参考: <a href="https://www.youtube.com/watch?v=9yeOJ0ZMUYw">SQL Joins Explained</a></p>
<h2 id="2-examples-in-the-book">2. Examples in the Book<a href="#2-examples-in-the-book" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<h3 id="21-reviews---one-to-many-relationship">2.1. Reviews - One to Many Relationship<a href="#21-reviews---one-to-many-relationship" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Each <em>product</em> can have many <em>reviews</em>, and you create this relationship by storing a <code>product_id</code> in each <em>review</em>, as shown in the sample document:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">_id:</span> <span style="color:#960050;background-color:#1e0010">ObjectId(</span><span style="color:#f92672">&#34;4c4b1476238d3b4dd5000041&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>,   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">product_id:</span> <span style="color:#960050;background-color:#1e0010">ObjectId(</span><span style="color:#f92672">&#34;4c4b1476238d3b4dd5003981&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>,   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">date:</span> <span style="color:#960050;background-color:#1e0010">new</span> <span style="color:#960050;background-color:#1e0010">Date(2010,</span> <span style="color:#960050;background-color:#1e0010">5,</span> <span style="color:#960050;background-color:#1e0010">7),</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">title:</span> <span style="color:#f92672">&#34;Amazing&#34;</span>,   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">text:</span> <span style="color:#f92672">&#34;Has a squeaky wheel, but still a darn good wheelbarrow.&#34;</span>,   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">rating:</span> <span style="color:#960050;background-color:#1e0010">4,</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">user_id:</span> <span style="color:#960050;background-color:#1e0010">ObjectId(</span><span style="color:#f92672">&#34;4c4b1476238d3b4dd5000042&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>,   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">username:</span> <span style="color:#f92672">&#34;dgreenthumb&#34;</span>,   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">helpful_votes:</span> <span style="color:#960050;background-color:#1e0010">3,</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">voter_ids:</span> <span style="color:#960050;background-color:#1e0010">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">ObjectId(</span><span style="color:#f92672">&#34;4c4b1476238d3b4dd5000033&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>,     
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">ObjectId(</span><span style="color:#f92672">&#34;7a4f0376238d3b4dd5000003&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>,     
</span></span><span style="display:flex;"><span>            <span style="color:#960050;background-color:#1e0010">ObjectId(</span><span style="color:#f92672">&#34;92c21476238d3b4dd5000032&#34;</span><span style="color:#960050;background-color:#1e0010">)</span>   
</span></span><span style="display:flex;"><span>        <span style="color:#960050;background-color:#1e0010">]</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>But it may come as a surprise that you store the username as well. If this were an RDBMS, you’d be able to pull in the username with a join on the users table. Because you don’t have the join option with MongoDB, you can proceed in one of two ways: either query against the user collection for each review or accept some <strong>denormalization</strong>. Issuing a query for every review might be unnecessarily costly when username is extremely unlikely to change, so here we’ve chosen to optimize for query speed rather than <strong>normalization</strong>.</p>
<p>Also noteworthy is the decision to store votes in the review document itself. It’s common for users to be able to vote on reviews. Here, you store the object ID of each voting user in an array of voter IDs. This allows you to prevent users from voting on a review more than once, and it also gives you the ability to query for all the reviews a user has voted on. You <strong>cache</strong> the total number of helpful votes, which among other things allows you to sort reviews based on helpfulness. Caching is useful, a query to sort reviews by helpful votes, for example, is much easier if the size of the voting array is cached in the helpful_votes field.</p>
<blockquote>
<p>用户名信息原本可以通过用户ID (<code>user_id</code>) 在用户集合(users collection)中查到, 但这样每次刷新评论都要重新查一次用户名.</p>
<p>这段提到了一个关键概念：缓存（Caching）, 这里的 “缓存” 是指在文档中直接存储一个额外的数据项（在这个例子中是“有帮助的投票数”），而不是每次查询时计算这个数值。</p>
</blockquote>
<h3 id="22-student--courses---many-to-many-relationship">2.2. Student &amp; Courses - Many to Many Relationship<a href="#22-student--courses---many-to-many-relationship" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p><strong>student:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">_id:</span> <span style="color:#960050;background-color:#1e0010">&lt;number&gt;,</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">name:</span> <span style="color:#960050;background-color:#1e0010">:</span> <span style="color:#960050;background-color:#1e0010">&lt;string&gt;,</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">otherDetails:</span> <span style="color:#960050;background-color:#1e0010">{</span> <span style="color:#960050;background-color:#1e0010">...</span> }<span style="color:#960050;background-color:#1e0010">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#960050;background-color:#1e0010">courses:</span> [
</span></span><span style="display:flex;"><span>      { <span style="color:#960050;background-color:#1e0010">courseId:</span>  <span style="color:#960050;background-color:#1e0010">&lt;number&gt;,</span> <span style="color:#960050;background-color:#1e0010">courseName:</span> <span style="color:#960050;background-color:#1e0010">&lt;string&gt;</span> },
</span></span><span style="display:flex;"><span>      { <span style="color:#960050;background-color:#1e0010">courseId:</span>  <span style="color:#960050;background-color:#1e0010">&lt;number&gt;,</span> <span style="color:#960050;background-color:#1e0010">courseName:</span> <span style="color:#960050;background-color:#1e0010">&lt;string&gt;</span> },
</span></span><span style="display:flex;"><span>      <span style="color:#960050;background-color:#1e0010">...</span>
</span></span><span style="display:flex;"><span>  ]
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div><p><strong>course:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">_id:</span> <span style="color:#960050;background-color:#1e0010">&lt;number&gt;,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">name:</span> <span style="color:#960050;background-color:#1e0010">&lt;string&gt;,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">description:</span> <span style="color:#960050;background-color:#1e0010">&lt;string&gt;,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#960050;background-color:#1e0010">otherDetails:</span> <span style="color:#960050;background-color:#1e0010">{</span> <span style="color:#960050;background-color:#1e0010">...</span> }
</span></span><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">}</span>
</span></span></code></pre></div><p>Now, your application has some queries. To start with some queries I can think about is, get all students in a particular course and get all courses for a particular student. These are simple queries.</p>
<p>To get all courses for a specific student, the query would be:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">students</span>.<span style="color:#a6e22e">find</span>( { <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;John Doe&#34;</span> }, { <span style="color:#a6e22e">courses</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> } )
</span></span></code></pre></div><p>To get all students enrolled for a specific course, your query can be like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">students</span>.<span style="color:#a6e22e">find</span>( { <span style="color:#e6db74">&#34;courses.courseName&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;Database Design&#34;</span> } )
</span></span></code></pre></div><p>This example is from <a href="https://www.mongodb.com/community/forums/t/many-to-many-relationship-and-linked-table-collection/130305/2">Many to many relationship and linked table/collection - Working with Data - MongoDB Developer Community Forums</a></p>
<h2 id="3-query-operators">3. Query Operators<a href="#3-query-operators" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>前面介绍了find函数的基本用法和projection参数, 在实际查询中, 我们还需要使用一些操作符来构建更复杂的查询条件, 接下来一一介绍.</p>
<p>Learn more: <a href="https://www.mongodb.com/docs/manual/reference/operator/query/">Query and Projection Operators — MongoDB Manual</a></p>
<h3 id="31-set-operators">3.1. Set operators<a href="#31-set-operators" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p><code>$in</code>, <code>$nin</code>, <code>$all</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// $in: Matches any of the values specified in an array.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">products</span>.<span style="color:#a6e22e">find</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;main_cat_id&#39;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#39;$in&#39;</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ObjectId</span>(<span style="color:#e6db74">&#34;6a5b1476238d3b4dd5000048&#34;</span>),         
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ObjectId</span>(<span style="color:#e6db74">&#34;6a5b1476238d3b4dd5000051&#34;</span>),         
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">ObjectId</span>(<span style="color:#e6db74">&#34;6a5b1476238d3b4dd5000057&#34;</span>)       
</span></span><span style="display:flex;"><span>        ]
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}, <span style="color:#66d9ef">null</span>, <span style="color:#66d9ef">null</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Query nested documents
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">products</span>.<span style="color:#a6e22e">find</span>({<span style="color:#e6db74">&#39;details.color&#39;</span><span style="color:#f92672">:</span> {<span style="color:#a6e22e">$in</span><span style="color:#f92672">:</span> [<span style="color:#e6db74">&#39;blue&#39;</span>, <span style="color:#e6db74">&#39;Green&#39;</span>]}})
</span></span></code></pre></div><h3 id="32-boolean-operators">3.2. Boolean operators<a href="#32-boolean-operators" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p><code>$or</code>, <code>$and</code>, <code>$not</code>, <code>$nor</code>, <code>$exists</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#75715e">// $or: matches if any of the supplied set of query terms is true
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Finding all products that are either blue or made by Acme requires:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">products</span>.<span style="color:#a6e22e">find</span>({
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#39;$or&#39;</span><span style="color:#f92672">:</span> [
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#39;details.color&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;blue&#39;</span>},
</span></span><span style="display:flex;"><span>        {<span style="color:#e6db74">&#39;manufacturer&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Acme&#39;</span>},
</span></span><span style="display:flex;"><span>    ]
</span></span><span style="display:flex;"><span>})
</span></span></code></pre></div><h2 id="4-update-atomic-operations-and-delete---action-in-mongodb-chapter-7">4. Update, atomic operations, and delete - Action in MongoDB chapter 7<a href="#4-update-atomic-operations-and-delete---action-in-mongodb-chapter-7" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<h3 id="41-update">4.1. Update<a href="#41-update" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>You can either replace the document altogether, or you can use update operators to modify specific fields within the document.</p>
<p><strong>modify by replacement:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">user_id</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ObjectId</span>(<span style="color:#e6db74">&#34;4c4b1476238d3b4dd5003981&#34;</span>) 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">doc</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">findOne</span>({<span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">user_id</span>}) 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">doc</span>[<span style="color:#e6db74">&#39;email&#39;</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;mongodb-user@mongodb.com&#39;</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">print</span>(<span style="color:#e6db74">&#39;updating &#39;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">user_id</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">update</span>({<span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">user_id</span>}, <span style="color:#a6e22e">doc</span>)
</span></span></code></pre></div><p>The final line says, “Find the document in the users collection with the given _id, and replace that document with the one we’ve provided.”</p>
<p><strong>modify by operator:</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#a6e22e">user_id</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">ObjectId</span>(<span style="color:#e6db74">&#34;4c4b1476238d3b4dd5000001&#34;</span>) 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">update</span>({<span style="color:#a6e22e">_id</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">user_id</span>},  {<span style="color:#a6e22e">$set</span><span style="color:#f92672">:</span> {<span style="color:#a6e22e">email</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;mongodb-user2@mongodb.com&#39;</span>}})
</span></span></code></pre></div><blockquote>
<p>Performance-conscious users may balk at the idea of re-aggregating all product reviews for each update. <strong>Much of this depends on the ratio of reads to writes</strong>; it’s likely that more users will see product reviews than write their own, so it makes sense to re-aggregate on a write.</p>
</blockquote>
<h3 id="42-standard-update-operators">4.2. Standard update operators<a href="#42-standard-update-operators" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>Certainly! Let&rsquo;s go through each MongoDB update operator with an explanation followed by a real-world example:</p>
<ol>
<li>
<p><strong><code>$set</code></strong>: Used to set the value of a field in a document. If the field does not exist, <code>$set</code> will add a new field with the specified value.</p>
<p>Example: Updating a user&rsquo;s email address.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">update</span>({ <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;johndoe&#39;</span> }, { <span style="color:#a6e22e">$set</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">email</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;johndoe@example.com&#39;</span> } });
</span></span></code></pre></div></li>
<li>
<p><strong><code>$unset</code></strong>: Removes the specified field from a document.</p>
<p>Example: Removing a phone number field from a user&rsquo;s profile.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">update</span>({ <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;johndoe&#39;</span> }, { <span style="color:#a6e22e">$unset</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">phoneNumber</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;&#34;</span> } });
</span></span></code></pre></div></li>
<li>
<p><strong><code>$inc</code></strong>: Increments the value of a field by the specified amount. If the field does not exist, it is set to the increment amount.</p>
<p>Example: Incrementing a user&rsquo;s reward points.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">update</span>({ <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;johndoe&#39;</span> }, { <span style="color:#a6e22e">$inc</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">rewardPoints</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">100</span> } });
</span></span></code></pre></div></li>
<li>
<p><strong><code>$push</code></strong>: Adds an element to an array. If the field is not an array, this operator will create an array with one element.</p>
<p>Example: Adding a new product to a user&rsquo;s wishlist.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">update</span>({ <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;johndoe&#39;</span> }, { <span style="color:#a6e22e">$push</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">wishlist</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;productId1234&#39;</span> } });
</span></span></code></pre></div></li>
<li>
<p><strong><code>$pull</code></strong>: Removes all instances of a value from an existing array.</p>
<p>Example: Removing an item from a user&rsquo;s shopping cart.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">users</span>.<span style="color:#a6e22e">update</span>({ <span style="color:#a6e22e">username</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;johndoe&#39;</span> }, { <span style="color:#a6e22e">$pull</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">shoppingCart</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;itemId5678&#39;</span> } });
</span></span></code></pre></div></li>
<li>
<p><strong><code>$addToSet</code></strong>: Adds a value to an array unless the value is already present, in which case <code>$addToSet</code> does nothing to ensure uniqueness.</p>
<p>Example: Adding a tag to a blog post without creating duplicates.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">blogPosts</span>.<span style="color:#a6e22e">update</span>({ <span style="color:#a6e22e">title</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;MongoDB Tips&#39;</span> }, { <span style="color:#a6e22e">$addToSet</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">tags</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;NoSQL&#39;</span> } });
</span></span></code></pre></div></li>
<li>
<p><strong><code>$rename</code></strong>: Renames a field.</p>
<p>Example: Changing a field name in a contact document.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">contacts</span>.<span style="color:#a6e22e">update</span>({ <span style="color:#a6e22e">name</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;Jane Doe&#39;</span> }, { <span style="color:#a6e22e">$rename</span><span style="color:#f92672">:</span> { <span style="color:#e6db74">&#39;cellphone&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;mobileNumber&#39;</span> } });
</span></span></code></pre></div></li>
<li>
<p><strong><code>$mul</code></strong>: Multiplies the value of the field by the specified amount. If the field does not exist, the operation sets the field to zero.</p>
<p>Example: Updating the price of a product in inventory.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">products</span>.<span style="color:#a6e22e">update</span>({ <span style="color:#a6e22e">productId</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;A123&#39;</span> }, { <span style="color:#a6e22e">$mul</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">price</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">2</span> } });
</span></span></code></pre></div></li>
</ol>
<h2 id="5-slow-queries---chapter-8-值得反复阅读">5. Slow queries - Chapter 8 值得反复阅读<a href="#5-slow-queries---chapter-8-值得反复阅读" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Finding slow queries is easy with MongoDB’s profiler. Discovering why these queries are slow is trickier and may require some detective work. As mentioned, the causes of slow queries are manifold. If you’re lucky, resolving a slow query may be as easy as adding an index. In more difficult cases, you might have to rearrange indexes, restructure the data model, or upgrade hardware.</p>
<p>MongoDB’s explain command provides detailed information about a given query’s path.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#960050;background-color:#1e0010">db.values.find(</span>{}<span style="color:#960050;background-color:#1e0010">).sort(</span>{<span style="color:#960050;background-color:#1e0010">close:</span> <span style="color:#960050;background-color:#1e0010">-1</span>}<span style="color:#960050;background-color:#1e0010">).limit(</span><span style="color:#ae81ff">1</span><span style="color:#960050;background-color:#1e0010">).explain()</span> 
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;cursor&#34;</span> : <span style="color:#e6db74">&#34;BasicCursor&#34;</span>,              
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;isMultiKey&#34;</span> : <span style="color:#66d9ef">false</span>,             
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">“</span>  <span style="color:#f92672">&#34;n&#34;</span> : <span style="color:#ae81ff">1</span>,                    <span style="color:#960050;background-color:#1e0010">#A</span>   <span style="color:#960050;background-color:#1e0010">Number</span> <span style="color:#960050;background-color:#1e0010">returned</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;nscannedObjects&#34;</span> : <span style="color:#ae81ff">4308303</span>,           
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;nscanned&#34;</span> : <span style="color:#ae81ff">4308303</span>,          <span style="color:#960050;background-color:#1e0010">#B</span>   <span style="color:#960050;background-color:#1e0010">Number</span> <span style="color:#960050;background-color:#1e0010">scanned</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;nscannedObjectsAllPlans&#34;</span> : <span style="color:#ae81ff">4308303</span>,    
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;scanAndOrder&#34;</span> : <span style="color:#66d9ef">true</span>,                
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&#34;millis&#34;</span> : <span style="color:#ae81ff">10927</span>,              <span style="color:#960050;background-color:#1e0010">#C</span>   <span style="color:#960050;background-color:#1e0010">Time</span> <span style="color:#960050;background-color:#1e0010">in</span> <span style="color:#960050;background-color:#1e0010">milliseconds,</span> <span style="color:#960050;background-color:#1e0010">11</span> <span style="color:#960050;background-color:#1e0010">seconds</span> <span style="color:#960050;background-color:#1e0010">this</span> <span style="color:#960050;background-color:#1e0010">query</span> <span style="color:#960050;background-color:#1e0010">took</span>
</span></span><span style="display:flex;"><span>    <span style="color:#960050;background-color:#1e0010">...</span>                 
</span></span><span style="display:flex;"><span>} 
</span></span></code></pre></div><p>The <code>cursor</code> field tells you that you’ve been using a <code>BasicCursor</code>, which only confirms that you’re scanning the collection itself and not an index. If you had used an index, the value would’ve been <code>BTreeCursor</code>.</p>
<p>A second datum here further explains the slowness of the query: the <code>scanAndOrder</code> field. This indicator appears when the query optimizer can’t use an index to return a sorted result set. Therefore, in this case, not only does the query engine have to scan the collection, it also has to sort the result set manually.</p>
<ol>
<li>Avoid <code>scanAndOrder</code>. If the query includes a sort, attempt to sort using an index.</li>
<li>Satisfy all fields with useful indexing constraints—attempt to use indexes for the fields in the query selector.</li>
<li>If the query implies a range or includes a sort, choose an index where that last key used can help satisfy the range or sort.</li>
</ol>
<p>当提到“last key used”这个术语，特别是在上下文中关于选择索引以优化范围查询或排序操作的讨论中，它指的是在复合索引中的最后一个字段。在复合索引中，字段的顺序是至关重要的，因为它决定了数据库如何组织和访问索引数据。让我们通过一个例子来解释这个概念。</p>
<p>假设你有一个MongoDB集合，其中包含以下字段：<code>a</code>, <code>b</code>, 和 <code>c</code>。现在，假设你创建了一个复合索引 <code>{ a: 1, b: 1, c: 1 }</code>。在这个索引中：</p>
<ul>
<li><code>a</code> 是第一个键，</li>
<li><code>b</code> 是第二个键，</li>
<li><code>c</code> 是“last key”或最后一个键。</li>
</ul>
<p>在处理查询时，如果查询涉及到这三个字段中的任意一个的范围条件或排序要求，索引的效率将取决于这些条件是如何与索引中的键匹配的。在理想情况下，你希望查询中的范围或排序操作直接对应于复合索引中的最后一个键，因为这样可以最大化索引的效用。</p>
<p>例如，考虑以下查询：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-javascript" data-lang="javascript"><span style="display:flex;"><span><span style="color:#a6e22e">db</span>.<span style="color:#a6e22e">collection</span>.<span style="color:#a6e22e">find</span>({ <span style="color:#a6e22e">a</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">10</span>, <span style="color:#a6e22e">b</span><span style="color:#f92672">:</span> { <span style="color:#a6e22e">$gt</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">5</span> } }).<span style="color:#a6e22e">sort</span>({ <span style="color:#a6e22e">c</span><span style="color:#f92672">:</span> <span style="color:#ae81ff">1</span> })
</span></span></code></pre></div><p>在这个查询中：</p>
<ul>
<li><code>a</code> 是一个精确匹配条件，</li>
<li><code>b</code> 是一个范围查询条件，</li>
<li><code>c</code> 是一个排序条件。</li>
</ul>
<p>索引 <code>{ a: 1, b: 1, c: 1 }</code> 在这种情况下是高效的，因为：</p>
<ul>
<li>它首先使用 <code>a</code> 来快速定位数据（第一个键），</li>
<li>接着，利用 <code>b</code> 来进一步过滤范围内的记录（第二个键），</li>
<li>最后，使用 <code>c</code> 进行排序（“last key”或最后一个键）。</li>
</ul>
<p>在这里，“last key” (<code>c</code>) 使得查询可以在使用索引的同时完成排序，从而避免了额外的排序步骤，提高了查询效率。所以，“last key”在复合索引中指的是最后一个被用来支持查询中的范围或排序条件的字段。</p>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">查看其他文章</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="https://blog.jiyi27.com/posts/rust/syntax/001-basics/" class="button inline prev">
        Rust Basics - Syntax, Types
      </a>
    
    
      ::
    
    
      <a href="https://blog.jiyi27.com/posts/database/mongodb/000-basics-golang/" class="button inline next">
        MongoDB Docs - Golang Basics
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/jiyi27/jiyi27.github.io" target="_blank">Theme</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
