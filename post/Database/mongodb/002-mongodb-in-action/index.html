<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>MongoDB in Action Reading Note - David&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="David" /><meta name="description" content="Basic Theory MongoDB stores its information in documents rather than rows. Where relational databases have tables, MongoDB has collections. Every MongoDB document requires an _id, and if one isn’t present when the document is created, a special MongoDB ObjectID will be generated and added to the document at that time. You can set your own _id by setting it in the document you insert, the ObjectID" />






<meta name="generator" content="Hugo 0.123.7 with theme even" />


<link rel="canonical" href="https://davidzhu.xyz/post/database/mongodb/002-mongodb-in-action/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="MongoDB in Action Reading Note" />
<meta property="og:description" content="Basic Theory MongoDB stores its information in documents rather than rows. Where relational databases have tables, MongoDB has collections. Every MongoDB document requires an _id, and if one isn’t present when the document is created, a special MongoDB ObjectID will be generated and added to the document at that time. You can set your own _id by setting it in the document you insert, the ObjectID" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://davidzhu.xyz/post/database/mongodb/002-mongodb-in-action/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2024-01-08T17:38:35+00:00" />
<meta property="article:modified_time" content="2024-01-08T17:38:35+00:00" />

<meta itemprop="name" content="MongoDB in Action Reading Note">
<meta itemprop="description" content="Basic Theory MongoDB stores its information in documents rather than rows. Where relational databases have tables, MongoDB has collections. Every MongoDB document requires an _id, and if one isn’t present when the document is created, a special MongoDB ObjectID will be generated and added to the document at that time. You can set your own _id by setting it in the document you insert, the ObjectID"><meta itemprop="datePublished" content="2024-01-08T17:38:35+00:00" />
<meta itemprop="dateModified" content="2024-01-08T17:38:35+00:00" />
<meta itemprop="wordCount" content="2427">
<meta itemprop="keywords" content="database,mongodb," /><meta name="twitter:card" content="summary"/><meta name="twitter:title" content="MongoDB in Action Reading Note"/>
<meta name="twitter:description" content="Basic Theory MongoDB stores its information in documents rather than rows. Where relational databases have tables, MongoDB has collections. Every MongoDB document requires an _id, and if one isn’t present when the document is created, a special MongoDB ObjectID will be generated and added to the document at that time. You can set your own _id by setting it in the document you insert, the ObjectID"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">David&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">David&#39;s Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">MongoDB in Action Reading Note</h1>

      <div class="post-meta">
        <span class="post-time"> 2024-01-08 </span>
        <div class="post-category">
            <a href="/categories/database/"> database </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#basic-theory">Basic Theory</a></li>
        <li><a href="#examples-in-the-book">Examples in the Book</a>
          <ul>
            <li><a href="#reviews---one-to-many-relationship">Reviews - One to Many Relationship</a></li>
          </ul>
        </li>
        <li><a href="#constructing-queries---action-in-mongodb-chapter-5">Constructing queries - Action in MongoDB chapter 5</a>
          <ul>
            <li><a href="#find--findone-functions">Find &amp; FindOne Functions</a></li>
            <li><a href="#projection-parameter-of-find-and-findone">Projection parameter of find and findOne</a></li>
          </ul>
        </li>
        <li><a href="#query-operators">Query Operators</a>
          <ul>
            <li><a href="#set-operators">Set operators</a></li>
            <li><a href="#boolean-operators">Boolean operators</a></li>
          </ul>
        </li>
        <li><a href="#querying-arrays">Querying arrays</a></li>
        <li><a href="#update-atomic-operations-and-delete---action-in-mongodb-chapter-7">Update, atomic operations, and delete - Action in MongoDB chapter 7</a>
          <ul>
            <li><a href="#update">Update</a></li>
            <li><a href="#standard-update-operators">Standard update operators</a></li>
          </ul>
        </li>
        <li><a href="#slow-queries---chapter-8-值得反复阅读">Slow queries - Chapter 8 值得反复阅读</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="basic-theory">Basic Theory</h2>
<p>MongoDB stores its information in <strong>documents</strong> rather than <strong>rows</strong>. Where relational databases have <strong>tables</strong>, MongoDB has <em><strong>collections</strong></em>.</p>
<p>Every MongoDB document requires an _id, and if one isn’t present when the document is created, a special MongoDB ObjectID will be generated and added to the document at that time. You can set your own _id by setting it in the document you insert, the ObjectID is just MongoDB’s default.</p>
<p>Indexes don’t come for free; they take up some space and can make your inserts slightly more expensive, but they are an essential tool for query optimization.</p>
<blockquote>
<p>MongoDB 没有传统数据库中 join 和 foreign key 的的概念, 但是可以通过嵌套文档或 Reference 来表示一对多或多对多的关系, 也可使用聚合来实现类似 Join 的功能. Join 为了同时获得多个表的内容, foreign key 为了数据一致性(data consistency and integrity), <a href="https://chat.openai.com/share/419afe95-279b-477f-8afa-8f75ab76edad">了解更多</a>
了解更多: <a href="https://davidzhu.xyz/post/database/mysql/002-basic-sql/">Basic MySQL - David&rsquo;s Blog</a></p>
</blockquote>
<h2 id="examples-in-the-book">Examples in the Book</h2>
<h3 id="reviews---one-to-many-relationship">Reviews - One to Many Relationship</h3>
<p>Each <em>product</em> can have many <em>reviews</em>, and you create this relationship by storing a <code>product_id</code> in each <em>review</em>, as shown in the sample document:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>   
</span></span><span class="line"><span class="cl">    <span class="err">_id:</span> <span class="err">ObjectId(</span><span class="nt">&#34;4c4b1476238d3b4dd5000041&#34;</span><span class="err">)</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="err">product_id:</span> <span class="err">ObjectId(</span><span class="nt">&#34;4c4b1476238d3b4dd5003981&#34;</span><span class="err">)</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="err">date:</span> <span class="err">new</span> <span class="err">Date(2010,</span> <span class="err">5,</span> <span class="err">7),</span>   
</span></span><span class="line"><span class="cl">    <span class="err">title:</span> <span class="nt">&#34;Amazing&#34;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="err">text:</span> <span class="nt">&#34;Has a squeaky wheel, but still a darn good wheelbarrow.&#34;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="err">rating:</span> <span class="err">4,</span>   
</span></span><span class="line"><span class="cl">    <span class="err">user_id:</span> <span class="err">ObjectId(</span><span class="nt">&#34;4c4b1476238d3b4dd5000042&#34;</span><span class="err">)</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="err">username:</span> <span class="nt">&#34;dgreenthumb&#34;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="err">helpful_votes:</span> <span class="err">3,</span>   
</span></span><span class="line"><span class="cl">    <span class="err">voter_ids:</span> <span class="err">[</span>
</span></span><span class="line"><span class="cl">            <span class="err">ObjectId(</span><span class="nt">&#34;4c4b1476238d3b4dd5000033&#34;</span><span class="err">)</span><span class="p">,</span>     
</span></span><span class="line"><span class="cl">            <span class="err">ObjectId(</span><span class="nt">&#34;7a4f0376238d3b4dd5000003&#34;</span><span class="err">)</span><span class="p">,</span>     
</span></span><span class="line"><span class="cl">            <span class="err">ObjectId(</span><span class="nt">&#34;92c21476238d3b4dd5000032&#34;</span><span class="err">)</span>   
</span></span><span class="line"><span class="cl">        <span class="err">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>But it may come as a surprise that you store the username as well. If this were an RDBMS, you’d be able to pull in the username with a join on the users table. Because you don’t have the join option with MongoDB, you can proceed in one of two ways: either query against the user collection for each review or accept some <strong>denormalization</strong>. Issuing a query for every review might be unnecessarily costly when username is extremely unlikely to change, so here we’ve chosen to optimize for query speed rather than <strong>normalization</strong>.</p>
<p>Also noteworthy is the decision to store votes in the review document itself. It’s common for users to be able to vote on reviews. Here, you store the object ID of each voting user in an array of voter IDs. This allows you to prevent users from voting on a review more than once, and it also gives you the ability to query for all the reviews a user has voted on. You <strong>cache</strong> the total number of helpful votes, which among other things allows you to sort reviews based on helpfulness. Caching is useful, a query to sort reviews by helpful votes, for example, is much easier if the size of the voting array is cached in the helpful_votes field.</p>
<p>这段提到了一个关键概念：缓存（Caching）, 这里的 “缓存” 是指在文档中直接存储一个额外的数据项（在这个例子中是“有帮助的投票数”），而不是每次查询时计算这个数值。</p>
<h2 id="constructing-queries---action-in-mongodb-chapter-5">Constructing queries - Action in MongoDB chapter 5</h2>
<h3 id="find--findone-functions">Find &amp; FindOne Functions</h3>
<p><code>find</code> returns a cursor object, whereas <code>findOne</code> returns a document. The findOne method is similar to the following, though a cursor is returned even when you apply a limit:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">mongoose</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">&#39;slug&#39;</span><span class="o">:</span> <span class="s1">&#39;wheel-barrow-9092&#39;</span><span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">).</span><span class="nx">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">mongoose</span><span class="p">.</span><span class="nx">reviews</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">&#39;product_id&#39;</span><span class="o">:</span> <span class="nx">product</span><span class="p">[</span><span class="s1">&#39;_id&#39;</span><span class="p">]},</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">sort</span><span class="p">({</span><span class="s1">&#39;helpful_votes&#39;</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="p">.</span><span class="nx">limit</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">mongoose</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">&#39;addresses.zip&#39;</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;$gt&#39;</span><span class="o">:</span> <span class="mi">10019</span><span class="p">,</span> <span class="s1">&#39;$lt&#39;</span><span class="o">:</span> <span class="mi">10040</span><span class="p">}},</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p><code>null</code> is in the mongoose stryle, I use Nodejs, so this can help remind me of the another two parameters: <code>projection</code> and <code>options</code>.
<code>db.collection.findOne(query, projection, options)</code></p>
</blockquote>
<h3 id="projection-parameter-of-find-and-findone">Projection parameter of find and findOne</h3>
<blockquote>
<p>MongoDB store documents in a collection in no particular order. To get documents in a particular order, you must can use the <code>sort()</code> method or the <code>$sort</code> aggregation pipeline stage.
Learn more: <a href="https://www.mongodb.com/docs/manual/reference/glossary/#std-term-natural-order">natural order — MongoDB Manual</a></p>
</blockquote>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">mongoose</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="err">“</span><span class="nx">username</span><span class="s1">&#39;: &#39;</span><span class="nx">kbanker</span><span class="s1">&#39;, &#39;</span><span class="nx">hashed_password</span><span class="s1">&#39;: &#39;</span><span class="nx">bd1cfa194c3a603e7186780824b04419</span><span class="s1">&#39;},
</span></span></span><span class="line"><span class="cl"><span class="s1">    {&#39;</span><span class="nx">_id</span><span class="err">&#39;</span><span class="o">:</span> <span class="mi">1</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="kc">null</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>If you are already familiar with SQL and RDBMS, this is the difference between <code>SELECT *</code> and <code>SELECT ID</code>.</p>
<h2 id="query-operators">Query Operators</h2>
<p>前面介绍了find函数的基本用法和projection参数, 在实际查询中, 我们还需要使用一些操作符来构建更复杂的查询条件, 接下来一一介绍.</p>
<p>Learn more: <a href="https://www.mongodb.com/docs/manual/reference/operator/query/">Query and Projection Operators — MongoDB Manual</a></p>
<h3 id="set-operators">Set operators</h3>
<p><code>$in</code>, <code>$nin</code>, <code>$all</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// $in: Matches any of the values specified in an array.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;main_cat_id&#39;</span><span class="o">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s1">&#39;$in&#39;</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&#34;6a5b1476238d3b4dd5000048&#34;</span><span class="p">),</span>         
</span></span><span class="line"><span class="cl">            <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&#34;6a5b1476238d3b4dd5000051&#34;</span><span class="p">),</span>         
</span></span><span class="line"><span class="cl">            <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&#34;6a5b1476238d3b4dd5000057&#34;</span><span class="p">)</span>       
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">},</span> <span class="kc">null</span><span class="p">,</span> <span class="kc">null</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// Query nested documents
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span><span class="s1">&#39;details.color&#39;</span><span class="o">:</span> <span class="p">{</span><span class="nx">$in</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="s1">&#39;Green&#39;</span><span class="p">]}})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="boolean-operators">Boolean operators</h3>
<p><code>$or</code>, <code>$and</code>, <code>$not</code>, <code>$nor</code>, <code>$exists</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="c1">// $or: matches if any of the supplied set of query terms is true
</span></span></span><span class="line"><span class="cl"><span class="c1">// Finding all products that are either blue or made by Acme requires:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;$or&#39;</span><span class="o">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s1">&#39;details.color&#39;</span><span class="o">:</span> <span class="s1">&#39;blue&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s1">&#39;manufacturer&#39;</span><span class="o">:</span> <span class="s1">&#39;Acme&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="querying-arrays">Querying arrays</h2>
<p><a href="https://www.mongodb.com/docs/manual/tutorial/query-arrays/">Query an Array — MongoDB Manual</a></p>
<h2 id="update-atomic-operations-and-delete---action-in-mongodb-chapter-7">Update, atomic operations, and delete - Action in MongoDB chapter 7</h2>
<h3 id="update">Update</h3>
<p>You can either replace the document altogether, or you can use update operators to modify specific fields within the document.</p>
<p><strong>modify by replacement:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">user_id</span> <span class="o">=</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&#34;4c4b1476238d3b4dd5003981&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="nx">doc</span> <span class="o">=</span> <span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">user_id</span><span class="p">})</span> 
</span></span><span class="line"><span class="cl"><span class="nx">doc</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;mongodb-user@mongodb.com&#39;</span> 
</span></span><span class="line"><span class="cl"><span class="nx">print</span><span class="p">(</span><span class="s1">&#39;updating &#39;</span> <span class="o">+</span> <span class="nx">user_id</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">user_id</span><span class="p">},</span> <span class="nx">doc</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>The final line says, “Find the document in the users collection with the given _id, and replace that document with the one we’ve provided.”</p>
<p><strong>modify by operator:</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-js" data-lang="js"><span class="line"><span class="cl"><span class="nx">user_id</span> <span class="o">=</span> <span class="nx">ObjectId</span><span class="p">(</span><span class="s2">&#34;4c4b1476238d3b4dd5000001&#34;</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span><span class="nx">_id</span><span class="o">:</span> <span class="nx">user_id</span><span class="p">},</span>  <span class="p">{</span><span class="nx">$set</span><span class="o">:</span> <span class="p">{</span><span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;mongodb-user2@mongodb.com&#39;</span><span class="p">}})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Performance-conscious users may balk at the idea of re-aggregating all product reviews for each update. <strong>Much of this depends on the ratio of reads to writes</strong>; it’s likely that more users will see product reviews than write their own, so it makes sense to re-aggregate on a write.</p>
</blockquote>
<h3 id="standard-update-operators">Standard update operators</h3>
<p>Certainly! Let&rsquo;s go through each MongoDB update operator with an explanation followed by a real-world example:</p>
<ol>
<li>
<p><strong><code>$set</code></strong>: Used to set the value of a field in a document. If the field does not exist, <code>$set</code> will add a new field with the specified value.</p>
<p>Example: Updating a user&rsquo;s email address.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;johndoe&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$set</span><span class="o">:</span> <span class="p">{</span> <span class="nx">email</span><span class="o">:</span> <span class="s1">&#39;johndoe@example.com&#39;</span> <span class="p">}</span> <span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong><code>$unset</code></strong>: Removes the specified field from a document.</p>
<p>Example: Removing a phone number field from a user&rsquo;s profile.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;johndoe&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$unset</span><span class="o">:</span> <span class="p">{</span> <span class="nx">phoneNumber</span><span class="o">:</span> <span class="s2">&#34;&#34;</span> <span class="p">}</span> <span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong><code>$inc</code></strong>: Increments the value of a field by the specified amount. If the field does not exist, it is set to the increment amount.</p>
<p>Example: Incrementing a user&rsquo;s reward points.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;johndoe&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$inc</span><span class="o">:</span> <span class="p">{</span> <span class="nx">rewardPoints</span><span class="o">:</span> <span class="mi">100</span> <span class="p">}</span> <span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong><code>$push</code></strong>: Adds an element to an array. If the field is not an array, this operator will create an array with one element.</p>
<p>Example: Adding a new product to a user&rsquo;s wishlist.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;johndoe&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$push</span><span class="o">:</span> <span class="p">{</span> <span class="nx">wishlist</span><span class="o">:</span> <span class="s1">&#39;productId1234&#39;</span> <span class="p">}</span> <span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong><code>$pull</code></strong>: Removes all instances of a value from an existing array.</p>
<p>Example: Removing an item from a user&rsquo;s shopping cart.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">users</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">username</span><span class="o">:</span> <span class="s1">&#39;johndoe&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$pull</span><span class="o">:</span> <span class="p">{</span> <span class="nx">shoppingCart</span><span class="o">:</span> <span class="s1">&#39;itemId5678&#39;</span> <span class="p">}</span> <span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong><code>$addToSet</code></strong>: Adds a value to an array unless the value is already present, in which case <code>$addToSet</code> does nothing to ensure uniqueness.</p>
<p>Example: Adding a tag to a blog post without creating duplicates.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">blogPosts</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">title</span><span class="o">:</span> <span class="s1">&#39;MongoDB Tips&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$addToSet</span><span class="o">:</span> <span class="p">{</span> <span class="nx">tags</span><span class="o">:</span> <span class="s1">&#39;NoSQL&#39;</span> <span class="p">}</span> <span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong><code>$rename</code></strong>: Renames a field.</p>
<p>Example: Changing a field name in a contact document.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">contacts</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">name</span><span class="o">:</span> <span class="s1">&#39;Jane Doe&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$rename</span><span class="o">:</span> <span class="p">{</span> <span class="s1">&#39;cellphone&#39;</span><span class="o">:</span> <span class="s1">&#39;mobileNumber&#39;</span> <span class="p">}</span> <span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
<li>
<p><strong><code>$mul</code></strong>: Multiplies the value of the field by the specified amount. If the field does not exist, the operation sets the field to zero.</p>
<p>Example: Updating the price of a product in inventory.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">products</span><span class="p">.</span><span class="nx">update</span><span class="p">({</span> <span class="nx">productId</span><span class="o">:</span> <span class="s1">&#39;A123&#39;</span> <span class="p">},</span> <span class="p">{</span> <span class="nx">$mul</span><span class="o">:</span> <span class="p">{</span> <span class="nx">price</span><span class="o">:</span> <span class="mi">2</span> <span class="p">}</span> <span class="p">});</span>
</span></span></code></pre></td></tr></table>
</div>
</div></li>
</ol>
<h2 id="slow-queries---chapter-8-值得反复阅读">Slow queries - Chapter 8 值得反复阅读</h2>
<p>Finding slow queries is easy with MongoDB’s profiler. Discovering why these queries are slow is trickier and may require some detective work. As mentioned, the causes of slow queries are manifold. If you’re lucky, resolving a slow query may be as easy as adding an index. In more difficult cases, you might have to rearrange indexes, restructure the data model, or upgrade hardware.</p>
<p>MongoDB’s explain command provides detailed information about a given query’s path.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="err">db.values.find(</span><span class="p">{}</span><span class="err">).sort(</span><span class="p">{</span><span class="err">close:</span> <span class="err">-1</span><span class="p">}</span><span class="err">).limit(</span><span class="mi">1</span><span class="err">).explain()</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;cursor&#34;</span> <span class="p">:</span> <span class="s2">&#34;BasicCursor&#34;</span><span class="p">,</span>              
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;isMultiKey&#34;</span> <span class="p">:</span> <span class="kc">false</span><span class="p">,</span>             
</span></span><span class="line"><span class="cl">    <span class="err">“</span>  <span class="nt">&#34;n&#34;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>                    <span class="err">#A</span>   <span class="err">Number</span> <span class="err">returned</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;nscannedObjects&#34;</span> <span class="p">:</span> <span class="mi">4308303</span><span class="p">,</span>           
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;nscanned&#34;</span> <span class="p">:</span> <span class="mi">4308303</span><span class="p">,</span>          <span class="err">#B</span>   <span class="err">Number</span> <span class="err">scanned</span>
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;nscannedObjectsAllPlans&#34;</span> <span class="p">:</span> <span class="mi">4308303</span><span class="p">,</span>    
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;scanAndOrder&#34;</span> <span class="p">:</span> <span class="kc">true</span><span class="p">,</span>                
</span></span><span class="line"><span class="cl">    <span class="nt">&#34;millis&#34;</span> <span class="p">:</span> <span class="mi">10927</span><span class="p">,</span>              <span class="err">#C</span>   <span class="err">Time</span> <span class="err">in</span> <span class="err">milliseconds,</span> <span class="err">11</span> <span class="err">seconds</span> <span class="err">this</span> <span class="err">query</span> <span class="err">took</span>
</span></span><span class="line"><span class="cl">    <span class="err">...</span>                 
</span></span><span class="line"><span class="cl"><span class="p">}</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>The <code>cursor</code> field tells you that you’ve been using a <code>BasicCursor</code>, which only confirms that you’re scanning the collection itself and not an index. If you had used an index, the value would’ve been <code>BTreeCursor</code>.</p>
<p>A second datum here further explains the slowness of the query: the <code>scanAndOrder</code> field. This indicator appears when the query optimizer can’t use an index to return a sorted result set. Therefore, in this case, not only does the query engine have to scan the collection, it also has to sort the result set manually.</p>
<ol>
<li>Avoid <code>scanAndOrder</code>. If the query includes a sort, attempt to sort using an index.</li>
<li>Satisfy all fields with useful indexing constraints—attempt to use indexes for the fields in the query selector.</li>
<li>If the query implies a range or includes a sort, choose an index where that last key used can help satisfy the range or sort.</li>
</ol>
<p>当提到“last key used”这个术语，特别是在上下文中关于选择索引以优化范围查询或排序操作的讨论中，它指的是在复合索引中的最后一个字段。在复合索引中，字段的顺序是至关重要的，因为它决定了数据库如何组织和访问索引数据。让我们通过一个例子来解释这个概念。</p>
<p>假设你有一个MongoDB集合，其中包含以下字段：<code>a</code>, <code>b</code>, 和 <code>c</code>。现在，假设你创建了一个复合索引 <code>{ a: 1, b: 1, c: 1 }</code>。在这个索引中：</p>
<ul>
<li><code>a</code> 是第一个键，</li>
<li><code>b</code> 是第二个键，</li>
<li><code>c</code> 是“last key”或最后一个键。</li>
</ul>
<p>在处理查询时，如果查询涉及到这三个字段中的任意一个的范围条件或排序要求，索引的效率将取决于这些条件是如何与索引中的键匹配的。在理想情况下，你希望查询中的范围或排序操作直接对应于复合索引中的最后一个键，因为这样可以最大化索引的效用。</p>
<p>例如，考虑以下查询：</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-javascript" data-lang="javascript"><span class="line"><span class="cl"><span class="nx">db</span><span class="p">.</span><span class="nx">collection</span><span class="p">.</span><span class="nx">find</span><span class="p">({</span> <span class="nx">a</span><span class="o">:</span> <span class="mi">10</span><span class="p">,</span> <span class="nx">b</span><span class="o">:</span> <span class="p">{</span> <span class="nx">$gt</span><span class="o">:</span> <span class="mi">5</span> <span class="p">}</span> <span class="p">}).</span><span class="nx">sort</span><span class="p">({</span> <span class="nx">c</span><span class="o">:</span> <span class="mi">1</span> <span class="p">})</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>在这个查询中：</p>
<ul>
<li><code>a</code> 是一个精确匹配条件，</li>
<li><code>b</code> 是一个范围查询条件，</li>
<li><code>c</code> 是一个排序条件。</li>
</ul>
<p>索引 <code>{ a: 1, b: 1, c: 1 }</code> 在这种情况下是高效的，因为：</p>
<ul>
<li>它首先使用 <code>a</code> 来快速定位数据（第一个键），</li>
<li>接着，利用 <code>b</code> 来进一步过滤范围内的记录（第二个键），</li>
<li>最后，使用 <code>c</code> 进行排序（“last key”或最后一个键）。</li>
</ul>
<p>在这里，“last key” (<code>c</code>) 使得查询可以在使用索引的同时完成排序，从而避免了额外的排序步骤，提高了查询效率。所以，“last key”在复合索引中指的是最后一个被用来支持查询中的范围或排序条件的字段。</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">David</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2024-01-08
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/database/">database</a>
          <a href="/tags/mongodb/">mongodb</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/database/mysql/002-basic-sql/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">Basic MySQL</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/database/mongodb/000-mongodb-practice/">
            <span class="next-text nav-default">MongoDB Docs</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:shwezhu@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/shwezhu" class="iconfont icon-github" title="github"></a>
  <a href="https://davidzhu.xyz/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2023 - 
    2024<span class="heart"><i class="iconfont icon-heart"></i></span><span>David</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
