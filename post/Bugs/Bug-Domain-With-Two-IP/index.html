<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>启动Cloudflare代理导致无法通过域名解析出A记录中的IP - David&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="David" /><meta name="description" content="这几天弄服务器, 用ssh通过域名连接的时候总是出现超时(域名只有一个A记录即服务器IP), 问题下面是分析思路, I&amp;rsquo;m trying to use ssh to connect my server with my domain name ssh root@www.davidzhu.xyz," />






<meta name="generator" content="Hugo 0.111.3 with theme even" />


<link rel="canonical" href="https://shaowenzhu.top/post/bugs/bug-domain-with-two-ip/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="启动Cloudflare代理导致无法通过域名解析出A记录中的IP" />
<meta property="og:description" content="这几天弄服务器, 用ssh通过域名连接的时候总是出现超时(域名只有一个A记录即服务器IP), 问题下面是分析思路, I&rsquo;m trying to use ssh to connect my server with my domain name ssh root@www.davidzhu.xyz," />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://shaowenzhu.top/post/bugs/bug-domain-with-two-ip/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-04-26T17:30:22+00:00" />
<meta property="article:modified_time" content="2023-04-26T17:30:22+00:00" />
<meta itemprop="name" content="启动Cloudflare代理导致无法通过域名解析出A记录中的IP">
<meta itemprop="description" content="这几天弄服务器, 用ssh通过域名连接的时候总是出现超时(域名只有一个A记录即服务器IP), 问题下面是分析思路, I&rsquo;m trying to use ssh to connect my server with my domain name ssh root@www.davidzhu.xyz,"><meta itemprop="datePublished" content="2023-04-26T17:30:22+00:00" />
<meta itemprop="dateModified" content="2023-04-26T17:30:22+00:00" />
<meta itemprop="wordCount" content="986">
<meta itemprop="keywords" content="Bugs,Build Website," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="启动Cloudflare代理导致无法通过域名解析出A记录中的IP"/>
<meta name="twitter:description" content="这几天弄服务器, 用ssh通过域名连接的时候总是出现超时(域名只有一个A记录即服务器IP), 问题下面是分析思路, I&rsquo;m trying to use ssh to connect my server with my domain name ssh root@www.davidzhu.xyz,"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">David&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">David&#39;s Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">启动Cloudflare代理导致无法通过域名解析出A记录中的IP</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-04-26 </span>
        <div class="post-category">
            <a href="/categories/bugs/"> Bugs </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents"></nav>
  </div>
</div>
    <div class="post-content">
      <p>这几天弄服务器, 用ssh通过域名连接的时候总是出现超时(域名只有一个A记录即服务器IP), 问题下面是分析思路,</p>
<p>I&rsquo;m trying to use <code>ssh</code> to connect my server with my domain name <code>ssh root@www.davidzhu.xyz</code>, but I always get timeout. However I can connect my server when use my server ip directly <code>ssh root@144.202.12.32</code>, so I was trying to use <code>tcpdump</code> to check what has happened, and I found when I use <code>ssh root@www.davidzhu.xyz</code>, there are two different target ip addresses like this:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">16:31:01.116901 IP 192.168.2.15.51247 &gt; 172.67.210.8.22: Flags <span class="o">[</span>S<span class="o">]</span>, seq 712140576, win 65535, options <span class="o">[</span>mss 1460,nop,wscale 6,nop,nop,TS val <span class="m">2121803756</span> ecr 0,sackOK,eol<span class="o">]</span>, length <span class="m">0</span>
</span></span><span class="line"><span class="cl">16:31:01.860841 IP 192.168.2.15.51244 &gt; 104.21.50.195.22: Flags <span class="o">[</span>S<span class="o">]</span>, seq 3164612131, win 65535, options <span class="o">[</span>mss 1460,nop,wscale 6,nop,nop,TS val <span class="m">1521852758</span> ecr 0,sackOK,eol<span class="o">]</span>, length <span class="m">0</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>So I use <code>dig</code> to check the ip address of my domain on DNS, the output is:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">dig davidzhu.xyz  +short       
</span></span><span class="line"><span class="cl">172.67.210.8
</span></span><span class="line"><span class="cl">104.21.50.195
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">dig www.davidzhu.xyz  +short
</span></span><span class="line"><span class="cl">172.67.210.8
</span></span><span class="line"><span class="cl">104.21.50.195
</span></span></code></pre></td></tr></table>
</div>
</div><p>But I only have one A record on my domain, this is the DNS Record of my domain name (the third one is about the google search console):</p>
<p><img src="a.png" alt=""></p>
<p>惊不惊讶, <strong><code>dig</code>返回的两个IP地址竟然都与我域名的A记录不同</strong>!</p>
<p>And I use cloudflare as my NS, cz I use it for free ssl. My two NS:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ dig chin.ns.cloudflare.com +short 
</span></span><span class="line"><span class="cl">172.64.32.84
</span></span><span class="line"><span class="cl">173.245.58.84
</span></span><span class="line"><span class="cl">108.162.192.84
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ dig noel.ns.cloudflare.com +short
</span></span><span class="line"><span class="cl">108.162.193.216
</span></span><span class="line"><span class="cl">172.64.33.216
</span></span><span class="line"><span class="cl">173.245.59.216
</span></span></code></pre></td></tr></table>
</div>
</div><p>And I saw <a href="https://superuser.com/a/1780483/1689666">another guy</a> use <code>dig</code> command to check the ip of my domain name <code>www.davidzhu.xyz</code>,</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">dig davidzhu.xyz +short
</span></span><span class="line"><span class="cl">144.202.12.32
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">dig www.davidzhu.xyz +short
</span></span><span class="line"><span class="cl">144.202.12.32
</span></span></code></pre></td></tr></table>
</div>
</div><p>Is this about DNS cache on my mac? I tried to use something like this <code>sudo killall -HUP mDNSResponder</code>, but no help.</p>
<hr>
<p>在<a href="https://stackexchange.com/">Stack Exchange</a>上的大佬帮助下, 研究明白了返回两个与我A记录不同IP的原因,</p>
<p>首先这并不是因为我本地电脑DNS缓存问题, 而是因为我在Cloudflare上启动了代理traffic, 即开启免费SSL证书, 我没证书, 他们有, 所有通过<code>http://www.davidzhu.xyz</code>访问我的流量会转发给他们然后变成<code>https</code>, 问题描述里的另一个人可以“正常”显示我的IP是因为当时我在Cloudflare的修改(启动Proxy, SSL)还没生效.</p>
<p>当时猜测是因为我的域名使用了Cloudflare的NS, 因为我想的是NS存储的就是map(我域名和其对应的IP地址), 如果是我域名指定的NS出了问题那就是访问不到我的IP地址或者因为缓存问题多返回了一个错误的IP地址(即我购买域名的时候默认的IP, 虽然我早删掉了), 但其实并不是因缓存问题, 而是我在Cloudflare开启了Proxy,</p>
<p>然后<a href="https://superuser.com/a/1781034/1689666">大佬</a>就想到了代理, 之前就是没想到代理也有IP地址, 即代理本质也是把所有请求都转发到另一台服务器(之前搞梯子竟然把这给忘了, 真是可恶).</p>
<blockquote>
<p>The reason that the domain has two IP addresses is that the domain was put under Cloudflare, and the way Cloudflare works is by proxying all your traffic through them (they have the SSL on their system, so it can&rsquo;t go directly to you.)</p>
</blockquote>
<p>然后我把Cloudflare上的代理关了, 之后就得到了正确的IP地址:</p>
<p><img src="b.png" alt=""></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">$ dig davidzhu.xyz +trace 
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">...
</span></span><span class="line"><span class="cl">davidzhu.xyz.       <span class="m">3600</span>    IN  NS  chin.ns.cloudflare.com.
</span></span><span class="line"><span class="cl">davidzhu.xyz.       <span class="m">3600</span>    IN  NS  noel.ns.cloudflare.com.
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Received <span class="m">581</span> bytes from 212.18.249.42#53<span class="o">(</span>generationxyz.nic.xyz<span class="o">)</span> in <span class="m">26</span> ms
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">davidzhu.xyz.       <span class="m">300</span> IN  A   144.202.12.32
</span></span><span class="line"><span class="cl"><span class="p">;;</span> Received <span class="m">57</span> bytes from 173.245.58.84#53<span class="o">(</span>chin.ns.cloudflare.com<span class="o">)</span> in <span class="m">34</span> ms
</span></span></code></pre></td></tr></table>
</div>
</div><p>所以这也知道了为啥通过域名使用ssh连接服务器总是超时了, 吗的, target ip都不是对的, 怎么可能连接的上</p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">David</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2023-04-26
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/bugs/">Bugs</a>
          <a href="/tags/build-website/">Build Website</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/build-website/modify-hexo-theme-in-css/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">微修Hexo主题CSS文件思路记录</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/java/backend/what-is-jar-package-in-java/">
            <span class="next-text nav-default">What is Jar Package in Java</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:shwezhu@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://twitter.com/shwezhu" class="iconfont icon-twitter" title="twitter"></a>
      <a href="http://localhost:1313" class="iconfont icon-linkedin" title="linkedin"></a>
      <a href="https://github.com/shwezhu" class="iconfont icon-github" title="github"></a>
  <a href="https://shaowenzhu.top/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>David</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
