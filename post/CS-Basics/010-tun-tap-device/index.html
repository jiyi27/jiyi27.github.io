<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>TUN/TAP Devices - David&#39;s Blog</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="David" /><meta name="description" content="1. TUN/TAP Devices In computer networking, TUN and TAP are two different kernel virtual network devices. Though both are for tunneling purposes, TUN and TAP can&amp;rsquo;t be used together because they transmit and receive packets at different layers of the network stack. TUN (network TUNnel) devices are used for IP packet-level tunneling, while TAP (network TAP) devices are used for Ethernet frame-level tunneling.
A network interface can be a physical device, called network interface controller (NIC), such as an ethernet card or wireless adapter, or a virtual device, such as a TUN or TAP interface." />






<meta name="generator" content="Hugo 0.111.3 with theme even" />


<link rel="canonical" href="https://davidzhu.xyz/post/cs-basics/010-tun-tap-device/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">



<link href="/sass/main.min.f92fd13721ddf72129410fd8250e73152cc6f2438082b6c0208dc24ee7c13fc4.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.css" integrity="sha256-7TyXnr2YU040zfSP+rEcz29ggW4j56/ujTPwjMzyqFY=" crossorigin="anonymous">


<meta property="og:title" content="TUN/TAP Devices" />
<meta property="og:description" content="1. TUN/TAP Devices In computer networking, TUN and TAP are two different kernel virtual network devices. Though both are for tunneling purposes, TUN and TAP can&rsquo;t be used together because they transmit and receive packets at different layers of the network stack. TUN (network TUNnel) devices are used for IP packet-level tunneling, while TAP (network TAP) devices are used for Ethernet frame-level tunneling.
A network interface can be a physical device, called network interface controller (NIC), such as an ethernet card or wireless adapter, or a virtual device, such as a TUN or TAP interface." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://davidzhu.xyz/post/cs-basics/010-tun-tap-device/" /><meta property="article:section" content="post" />
<meta property="article:published_time" content="2023-09-08T17:54:59+00:00" />
<meta property="article:modified_time" content="2023-09-08T17:54:59+00:00" />
<meta itemprop="name" content="TUN/TAP Devices">
<meta itemprop="description" content="1. TUN/TAP Devices In computer networking, TUN and TAP are two different kernel virtual network devices. Though both are for tunneling purposes, TUN and TAP can&rsquo;t be used together because they transmit and receive packets at different layers of the network stack. TUN (network TUNnel) devices are used for IP packet-level tunneling, while TAP (network TAP) devices are used for Ethernet frame-level tunneling.
A network interface can be a physical device, called network interface controller (NIC), such as an ethernet card or wireless adapter, or a virtual device, such as a TUN or TAP interface."><meta itemprop="datePublished" content="2023-09-08T17:54:59+00:00" />
<meta itemprop="dateModified" content="2023-09-08T17:54:59+00:00" />
<meta itemprop="wordCount" content="847">
<meta itemprop="keywords" content="cs basics,networking," /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="TUN/TAP Devices"/>
<meta name="twitter:description" content="1. TUN/TAP Devices In computer networking, TUN and TAP are two different kernel virtual network devices. Though both are for tunneling purposes, TUN and TAP can&rsquo;t be used together because they transmit and receive packets at different layers of the network stack. TUN (network TUNnel) devices are used for IP packet-level tunneling, while TAP (network TAP) devices are used for Ethernet frame-level tunneling.
A network interface can be a physical device, called network interface controller (NIC), such as an ethernet card or wireless adapter, or a virtual device, such as a TUN or TAP interface."/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">David&#39;s Blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>

  


</nav>

  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">David&#39;s Blog</a>
</div>





<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>

    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">TUN/TAP Devices</h1>

      <div class="post-meta">
        <span class="post-time"> 2023-09-08 </span>
        <div class="post-category">
            <a href="/categories/cs-basics/"> cs basics </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#1-tuntap-devices">1. TUN/TAP Devices</a></li>
        <li><a href="#2-tuntap--network-stack">2. TUN/TAP &amp; Network Stack</a></li>
        <li><a href="#3-tun-vs-tap">3. TUN vs. TAP</a>
          <ul>
            <li><a href="#31-tun-interfaces-l3">3.1. TUN interfaces (L3)</a></li>
            <li><a href="#32-tap-interfaces-l2">3.2. TAP interfaces (L2)</a></li>
          </ul>
        </li>
        <li><a href="#4-set-up-tuntap-devices">4. Set up TUN/TAP devices</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h2 id="1-tuntap-devices">1. TUN/TAP Devices</h2>
<p>In computer networking, <strong>TUN</strong> and <strong>TAP</strong> are two different kernel <strong>virtual network devices</strong>. Though both are for tunneling purposes, TUN and TAP can&rsquo;t be used together because they transmit and receive packets at different layers of the network stack. TUN (network TUNnel) devices are used for IP packet-level tunneling, while TAP (network TAP) devices are used for Ethernet frame-level tunneling.</p>
<blockquote>
<p>A network interface can be a physical device, called network interface controller (NIC), such as an ethernet card or wireless adapter, or a virtual device, such as a TUN or TAP interface.</p>
<p>Source: <a href="https://www.baeldung.com/linux/create-check-network-interfaces">https://www.baeldung.com/linux/create-check-network-interfaces</a></p>
<p>TUN/TAP provides packet reception and transmission for user space programs. It can be seen as a simple Point-to-Point or Ethernet device, which, instead of receiving packets from physical media, receives them from user space program and instead of sending packets via physical media writes them to the user space program. It interacts with user space program not the kernel.</p>
<p>Source: <a href="https://docs.kernel.org/networking/tuntap.html">https://docs.kernel.org/networking/tuntap.html</a></p>
</blockquote>
<h2 id="2-tuntap--network-stack">2. TUN/TAP &amp; Network Stack</h2>
<p>TUN/TAP is an operating-system interface for creating network interfaces managed by userspace. This is usually used to implement userspace Virtual Private Networks[<a href="https://www.gabriel.urdhr.fr/2021/05/08/tuntap/#fn1">1]</a> (VPNs), for example with <a href="https://openvpn.net/">OpenVPN</a>, <a href="https://www.gabriel.urdhr.fr/2017/08/02/foo-over-ssh/#tuntap-forwarding">OpenSSH</a> (<code>Tunnel</code> configuration or <code>-w</code> argument), <a href="https://code.ffdn.org/l2tpns/l2tpns">l2tpns</a>, etc.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">+--------------------------------------------+
</span></span><span class="line"><span class="cl">| Processes                                  |
</span></span><span class="line"><span class="cl">+--------------------------------------------+
</span></span><span class="line"><span class="cl">  ↕ Socket interface
</span></span><span class="line"><span class="cl">+---------------------------------------------+
</span></span><span class="line"><span class="cl">| Network Stack (kernel)                      |&lt;--+
</span></span><span class="line"><span class="cl">+---------------------------------------------+   |
</span></span><span class="line"><span class="cl">  ↕ Eth. frame     ↕ Eth. frame    ↕ IP packet    |
</span></span><span class="line"><span class="cl">+--------------+ +-------------+ +------------+   |
</span></span><span class="line"><span class="cl">| enp2s0       | | tap0        | | tun0       |   |
</span></span><span class="line"><span class="cl">+--------------+ +-------------+ +------------+   |
</span></span><span class="line"><span class="cl">  ↑ Eth. frame     ↕ Eth. frame¹   ↕ IP packet¹   |
</span></span><span class="line"><span class="cl">+--------------+ +-------------+ +------------+   |
</span></span><span class="line"><span class="cl">| Driver       | | Process     | | Process    |   |
</span></span><span class="line"><span class="cl">+--------------+ +-------------+ +------------+   |
</span></span><span class="line"><span class="cl">  ↕ Eth. frame²    ↑               ↑              |
</span></span><span class="line"><span class="cl">+--------------+   +---------------+--------------+
</span></span><span class="line"><span class="cl">| Eth. Adapter  |  (encapsulated packets)
</span></span><span class="line"><span class="cl">+--------------+
</span></span><span class="line"><span class="cl">  ↕ Eth. frame
</span></span><span class="line"><span class="cl">+--------------+
</span></span><span class="line"><span class="cl">| Eth. Network |
</span></span><span class="line"><span class="cl">+--------------+
</span></span><span class="line"><span class="cl">Physical netdev    Ethernet VPN      IP VPN
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">¹: via /dev/net/tun
</span></span><span class="line"><span class="cl">²: over PCI Express for example
</span></span></code></pre></td></tr></table>
</div>
</div><p>There are many applications running on our OS (reside in user space), they send network packets with socket interface (on linux). All the packets through <strong>socket interface</strong> will go to one place: the <strong>Network Stack</strong> (resides in kernel). And the packets from the Network Stack only have two direction to go, one is the physical network interfce (<strong>NIC</strong>), another direction is the virtual network devices <strong>tap/tun</strong>, and we can get the packets from tap/tun which usually used in VPN application (resides in user space). Of course, VPN applicatipn (user space) can write packet into <strong>tap/tun</strong> devices and after written into tap/tun the packet will goes to <strong>Network Stack</strong>, and there are two direction again&hellip;</p>
<p>You probably notice that if we use TUN/TAP devices to handle the packets from other normal  applications, the packet seem to go through the Network Stack twice: the normal applications write data into socket interface and these packets will go through Netwok Stack and intercepted by TUN/TAP devices, then after vpn handles these packets, these packet will be sent to Network Stack again, which probably not efficient. (Notice that in qemu-kvm, tap device works with bridge, and the packets goes to bridge directly without going through Network Stack which is more efficient)</p>
<p>Applications send or receive packet to/from socket interface:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">socket</span> <span class="o">=</span> <span class="nf">socket</span><span class="p">(</span><span class="n">AF_PACKET</span><span class="p">,</span><span class="n">SOCK_RAW</span><span class="p">,</span><span class="n">IPPROTO_IP</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>VPN application send or receive packet to/from tun devices:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// Request a TUN device
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="nf">open</span><span class="p">(</span><span class="s">&#34;/dev/net/tun&#34;</span><span class="p">,</span> <span class="n">O_RDWR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// receives a (single) packet or frame from the virtual network interface;
</span></span></span><span class="line"><span class="cl"><span class="c1">// Read an IP packet (because TUN works on IP layer):
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">ssize_t</span> <span class="n">count</span> <span class="o">=</span> <span class="nf">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">BUFFLEN</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// sends a (single) packet or frame to the virtual network interface;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nf">write</span><span class="p">(...)</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p>Source: <a href="https://www.gabriel.urdhr.fr/2021/05/08/tuntap/">TUN/TAP interface (on Linux) - /dev/posts/</a></p>
<h2 id="3-tun-vs-tap">3. TUN vs. TAP</h2>
<p>There are two types of virtual network interfaces managed by <code>/dev/net/tun</code>:</p>
<ul>
<li>TUN interfaces transport IP packets (layer 3);</li>
<li>TAP interfaces transport Ethernet frames (layer 2).</li>
</ul>
<h3 id="31-tun-interfaces-l3">3.1. TUN interfaces (L3)</h3>
<p>TUN interfaces (<code>IFF_TUN</code>) transport layer 3 (L3) Protocol Data Units (PDUs):</p>
<ul>
<li>in practice, it transports IPv4 and/or IPv6 packets;</li>
<li><code>read()</code> gets a L3 PDU (an IP packet);</li>
<li>you must <code>write()</code> L3 PDUs (an IP packet);</li>
<li>there is no layer 2 (Ethernet, etc.) involved in the interface;</li>
</ul>
<h3 id="32-tap-interfaces-l2">3.2. TAP interfaces (L2)</h3>
<p>TAP interfaces (<code>IFF_TUN</code>) transport layer 2 (L2) PDUs:</p>
<ul>
<li>in practice, it transports Ethernet frames (i.e. this is a virtual Ethernet adapter);</li>
<li><code>read()</code> gets a L2 PDU;</li>
<li>you must <code>write()</code> L2 PDUs.</li>
</ul>
<p>Source: <a href="https://www.gabriel.urdhr.fr/2021/05/08/tuntap/">TUN/TAP interface (on Linux) - /dev/posts/</a></p>
<h2 id="4-set-up-tuntap-devices">4. Set up TUN/TAP devices</h2>
<p>Because TUN is a layer 3 connection, it acts as a point-to-point link. We’ll assign these parameters:</p>
<ul>
<li>local address (for your machine): 192.0.2.1</li>
<li>remote address (for Scapy): 192.0.2.2</li>
</ul>
<p>On Linux, you would use:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo ip link <span class="nb">set</span> tun0 up
</span></span><span class="line"><span class="cl">sudo ip addr add 192.0.2.1 peer 192.0.2.2 dev tun0 
</span></span><span class="line"><span class="cl"><span class="c1"># sudo ip addr add 192.0.2.1 peer 192.0.2.2 dev tun0  up</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>On BSD and macOS, use:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">sudo ifconfig tun0 up
</span></span><span class="line"><span class="cl">sudo ifconfig tun0 192.0.2.1 192.0.2.2
</span></span><span class="line"><span class="cl"><span class="c1"># sudo ifconfig tun0 192.0.2.1 192.0.2.2 up</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Source: <a href="https://scapy.readthedocs.io/en/latest/layers/tuntap.html#tuntapinterface-reference">https://scapy.readthedocs.io/en/latest/layers/tuntap.html#tuntapinterface-reference</a></p>

    </div>

    <div class="post-copyright">
  <p class="copyright-item">
    <span class="item-title">Author</span>
    <span class="item-content">David</span>
  </p>
  <p class="copyright-item">
    <span class="item-title">LastMod</span>
    <span class="item-content">
        2023-09-08
        
    </span>
  </p>
  
  
</div>
<footer class="post-footer">
      <div class="post-tags">
          <a href="/tags/cs-basics/">cs basics</a>
          <a href="/tags/networking/">networking</a>
          </div>
      <nav class="post-nav">
        <a class="prev" href="/post/cs-basics/012-ddos-attack/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">DDoS Attack</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/golang/basics/008-error-handling/">
            <span class="next-text nav-default">Error handling - Go</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:shwezhu@qq.com" class="iconfont icon-email" title="email"></a>
      <a href="https://github.com/shwezhu" class="iconfont icon-github" title="github"></a>
  <a href="https://davidzhu.xyz/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2023<span class="heart"><i class="iconfont icon-heart"></i></span><span>David</span>
  </span>
</div>

    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/slideout@1.0.1/dist/slideout.min.js" integrity="sha256-t+zJ/g8/KXIJMjSVQdnibt4dlaDxc9zXr/9oNPeWqdg=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.1.20/dist/jquery.fancybox.min.js" integrity="sha256-XVLffZaxoWfGUEbdzuLi7pwaUJv1cecsQJQqGLe7axY=" crossorigin="anonymous"></script>



<script type="text/javascript" src="/js/main.min.4ae89da218555efa0e7093a20b92017d2e1202b66fff9fc2edf4cb8d44b44c6e.js"></script>








</body>
</html>
