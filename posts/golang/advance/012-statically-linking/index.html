<!DOCTYPE html>
<html lang="en">
<head>
  
    
    <title>Static Linking Go Programs :: 为霜的博客</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="1. Static linking on linux Go creates static binaries by default unless you use cgo to call C code, in which case it will create a dynamically linked binary. The easiest way to check if your program is statically compiled is to run file on it.
standard packages os/user and net use cgo, so importing either (directly or indirectly) will result in a dynamic binary.
Note that net use cgo does&rsquo;t mean that all the codes in net are cgo, cgo is just used for Name Resolution(resolving domain names) and some teivial features in net. https://pkg.go.dev/net#section-documentation
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://blog.jiyi27.com/posts/golang/advance/012-statically-linking/" />





  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/categories.min.3202f75cbb294747099af3850a68a09ee94b3ce505fc39e134692d90ff0a9b2a.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/code.min.dd73d157e77e82a3dc1cb06ba424cf6cc6811af0bb604ad6c68e70faf2439c8a.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/main.min.3fb8954e26342ad3afabb4525959bfec6f9fc0d6929f0dda738ddeee30211690.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/menu.min.8cee75f73b9f9b1e40bd0dd53e6e770156b08bbfe1c579cd256c3f6cd3b6d32b.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/post.min.014a50745fbdd41d5f420a3e288730d5af4b7d90344dc6211d0e50c368b5b303.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/prism.min.b958d3d7c6c67361b945f9062d07d403422604b3d2cd33f93b88d41ed0ba634d.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/term.min.94de320c1b850e126e6d2c88a7c90acf58bb1313f0ea14a14cda2a42f2a88db2.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="https://blog.jiyi27.com/terminal.css">




<link rel="shortcut icon" href="https://blog.jiyi27.com/favicon.png">
<link rel="apple-touch-icon" href="https://blog.jiyi27.com/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Static Linking Go Programs">
<meta property="og:description" content="1. Static linking on linux Go creates static binaries by default unless you use cgo to call C code, in which case it will create a dynamically linked binary. The easiest way to check if your program is statically compiled is to run file on it.
standard packages os/user and net use cgo, so importing either (directly or indirectly) will result in a dynamic binary.
Note that net use cgo does&rsquo;t mean that all the codes in net are cgo, cgo is just used for Name Resolution(resolving domain names) and some teivial features in net. https://pkg.go.dev/net#section-documentation
" />
<meta property="og:url" content="https://blog.jiyi27.com/posts/golang/advance/012-statically-linking/" />
<meta property="og:site_name" content="为霜的博客" />

  <meta property="og:image" content="https://blog.jiyi27.com/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">

  <meta property="article:section" content="golang" />


  <meta property="article:published_time" content="2023-10-10 12:09:35 &#43;0000 UTC" />












</head>
<body>


<div class="container center">

  
  
  

  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.jiyi27.com/posts/golang/advance/012-statically-linking/">Static Linking Go Programs</a>
  </h1>
  <div class="post-meta"><time class="post-date">2023-10-10</time><span class="post-reading-time">6 分钟阅读 (1172 字数)</span></div>

  
    <span class="post-tags">
      
      #<a href="https://blog.jiyi27.com/tags/golang/">golang</a>&nbsp;
      
      #<a href="https://blog.jiyi27.com/tags/%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/">编译原理</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <h2 id="1-static-linking-on-linux">1. Static linking on linux<a href="#1-static-linking-on-linux" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Go creates <strong>static binaries</strong> by default unless you use cgo to call C code, in which case it will create a dynamically linked binary. The easiest way to check if your program is statically compiled is to run <code>file</code> on it.</p>
<p>standard packages <code>os/user</code> and <code>net</code>  use cgo, so importing either (directly or indirectly) will result in a dynamic binary.</p>
<blockquote>
<p>Note that <code>net</code> use cgo does&rsquo;t mean that all the codes in <code>net</code> are cgo, cgo is just used for Name Resolution(resolving domain names) and some teivial features in <code>net</code>. <a href="https://pkg.go.dev/net#section-documentation">https://pkg.go.dev/net#section-documentation</a></p>
</blockquote>
<p>I do this test on my Ubuntu server firstly without cgo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [19:40:23] </span>
</span></span><span style="display:flex;"><span>$ go build -o server main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [19:40:31] </span>
</span></span><span style="display:flex;"><span>$ file server 
</span></span><span style="display:flex;"><span>server: ELF 64-bit LSB executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, statically linked, Go BuildID<span style="color:#f92672">=</span>hjbIteBvAg_rZ86av_gy/k1xYD8duMhRTtrThDrrX/5yBtTaOBDsf4F2IOwADX/U1b5vnivY9rWcRUWpC_A, with debug_info, not stripped
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [19:40:36] </span>
</span></span><span style="display:flex;"><span>$ ldd server 
</span></span><span style="display:flex;"><span>	not a dynamic executable
</span></span></code></pre></div><p>As you can see, I just use <code>fmt</code> package, and the executable file is statically linked.</p>
<p>And then I change the go code to:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">srv</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServeMux</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintln</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;hello world&#34;</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;running...&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#a6e22e">srv</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Then build it on Ubtutu machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [19:47:06]</span>
</span></span><span style="display:flex;"><span>$ go build -o server main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [19:47:31] </span>
</span></span><span style="display:flex;"><span>$ file server 
</span></span><span style="display:flex;"><span>server: ELF 64-bit LSB executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, Go BuildID<span style="color:#f92672">=</span>KCFaacb5_zSot7hqkTv8/oYQa-0nbl_Gq2_YxF6JO/BnF2hmfFNgVx-UHRKxMt/Oj91sMcK9_or35yi4Xd0, with debug_info, not stripped
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [19:47:39] </span>
</span></span><span style="display:flex;"><span>$ ldd server 
</span></span><span style="display:flex;"><span>	linux-vdso.so.1 <span style="color:#f92672">(</span>0x00007fff10cfb000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	libc.so.6 <span style="color:#f92672">=</span>&gt; /lib/x86_64-linux-gnu/libc.so.6 <span style="color:#f92672">(</span>0x00007f4cd6200000<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	/lib64/ld-linux-x86-64.so.2 <span style="color:#f92672">(</span>0x00007f4cd6612000<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>The binary file is dynamically linked as we expected.</p>
<h3 id="11-disable-dynamically-linking-with--cgo_enabled0">1.1. Disable dynamically linking with <code> CGO_ENABLED=0</code><a href="#11-disable-dynamically-linking-with--cgo_enabled0" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [19:48:57] </span>
</span></span><span style="display:flex;"><span>$ CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> go build -o server main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [20:11:01] </span>
</span></span><span style="display:flex;"><span>$ file server 
</span></span><span style="display:flex;"><span>server: ELF 64-bit LSB executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, statically linked, Go BuildID<span style="color:#f92672">=</span>wGRY1RH-HeASVOwzThcj/lQNxgqzqGUe1P8n_WjN7/cEcN362GspK8XKl2L0AG/F7hVHMJfVIyYcLM6Jhz1, with debug_info, not stripped
</span></span></code></pre></div><blockquote>
<p>Note that the <code>CGO_ENABLED=0</code> is to disable cgo. It is disabled by default when cross-compiling. You can control this by setting the CGO_ENABLED environment variable when running the go tool: set it to 1 to enable the use of cgo, and to 0 to disable it.</p>
<p>If CGO_ENABLED=0 is set, the Go net package will not use cgo, and instead, it will use a pure Go implementation for its networking functionality.</p>
<p>Learn more: <a href="https://go-review.googlesource.com/c/go/&#43;/12603/2/src/cmd/cgo/doc.go">https://go-review.googlesource.com/c/go/+/12603/2/src/cmd/cgo/doc.go</a></p>
</blockquote>
<h2 id="2-static-linking-on-osx">2. Static linking on osx<a href="#2-static-linking-on-osx" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>On Mac, the behavior is totoally different, even don&rsquo;t use cgo the final executable will be dynamically linked.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;hello&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Build on <strong>MacOS machine</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ go build -o server main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ file server 
</span></span><span style="display:flex;"><span>server: Mach-O 64-bit executable arm64
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># otool is similar to &#39;ldd&#39; on linux</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># -L print shared libraries used</span>
</span></span><span style="display:flex;"><span>$ otool -L server
</span></span><span style="display:flex;"><span>server:
</span></span><span style="display:flex;"><span>	/usr/lib/libSystem.B.dylib <span style="color:#f92672">(</span>compatibility version 0.0.0, current version 0.0.0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>	/usr/lib/libresolv.9.dylib <span style="color:#f92672">(</span>compatibility version 0.0.0, current version 0.0.0<span style="color:#f92672">)</span>
</span></span></code></pre></div><p><strong><code>CGO_ENABLED=0</code> won&rsquo;t help on MaxOS</strong>. And I found something could be explain this:</p>
<blockquote>
<p>I think this won&rsquo;t work on macOS, where <strong>fully static builds are not allowed/supported by Apple</strong>. Binaries should always go through libSystem, which is also why we changed the way Go calls the kernel in Go 1.12. So, pure Go binaries are already as static as they can be, as far as I can tell.</p>
<p>I propose that on macOS <code>go build -static</code> simply tries to statically link cgo libraries, so that the final binary doesn&rsquo;t depend on third-party. So but just on system libraries. To do this, unfortunately, it looks like it&rsquo;s not sufficient to add the output of <code>pkg-config --static --libs</code> to <code>LDFLAGS</code> because that output still refers to each library as <code>-L/path/to -lfoo</code> (as this is the correct syntax when <code>--static</code> is passed to the linker, which we are not going to do in macOS). So, the output of <code>pkg-config</code> should be rewritten as <code>/path/to/libfoo.a</code> (using a similar library path search algorithm that the linker does).</p>
<p>Source: <a href="https://github.com/golang/go/issues/26492#issuecomment-525527016">https://github.com/golang/go/issues/26492#issuecomment-525527016</a></p>
</blockquote>
<blockquote>
<p>Yes, I agree with Volker&rsquo;s comment that some systems don&rsquo;t really allow static binaries.</p>
<p>Source: <a href="https://stackoverflow.com/a/61324538/16317008">https://stackoverflow.com/a/61324538/16317008</a></p>
</blockquote>
<p>Note that fully static builds are not allowed/supported by Apple doesn&rsquo;t mean we cannot create statically linked binaries on Mac, we can build the binary executable on other platforms, linux, for example.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;net/http&#34;</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">srv</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">NewServeMux</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">srv</span>.<span style="color:#a6e22e">HandleFunc</span>(<span style="color:#e6db74">&#34;/&#34;</span>, <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>) {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Fprintln</span>(<span style="color:#a6e22e">w</span>, <span style="color:#e6db74">&#34;hello world&#34;</span>)
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;running...&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span> = <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ListenAndServe</span>(<span style="color:#e6db74">&#34;:8080&#34;</span>, <span style="color:#a6e22e">srv</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Build on MacOS machine with some flags:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ GOOS<span style="color:#f92672">=</span>linux go build -o server main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>$ file server                          
</span></span><span style="display:flex;"><span>server: ELF 64-bit LSB executable, ARM aarch64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, statically linked, Go BuildID<span style="color:#f92672">=</span>qAraNfnU-cYn-2KsoFx7/rrJYFJTR911CeHr08Y4E/uoFKsYV1LH9as_7QdMc7/fJ71_ARZOiNg7b4tLPIt, with debug_info, not stripped
</span></span></code></pre></div><p>As you can see, even we use the <code>net</code> package which uses cgo, it still can be statically with <code>GOOS=linux</code> flag, this is called cross compilation, learn more: <a href="https://davidzhu.xyz/post/golang/advance/011-cross-compilation/">Cross Compilation - Go - David&rsquo;s Blog</a></p>
<p>But the arch is arm64, not amd64, if you want build binary gonna runs on amd64, you should add <code>GOARCH=amd64</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ GOOS<span style="color:#f92672">=</span>linux GOARCH<span style="color:#f92672">=</span>amd64 go build -o server main.go
</span></span></code></pre></div><h2 id="3--extldflags-static">3. <code>&quot;-extldflags=-static&quot;</code><a href="#3--extldflags-static" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>In previous part, we know that <code>CGO_ENABLED=0</code> will disable cgo, if we use <code>net</code> and we want statically linking, it&rsquo;s fine we just pass <code>CGO_ENABLED=0</code> to go build, then we will use pure go implementation of <code>net</code>. But what if we use a third party package that only implemented by cgo, <a href="https://github.com/mattn/go-sqlite3">mattn/go-sqlite3</a> for example, and we want make it linked statically, apparently we can&rsquo;t use <code>CGO_ENABLED=0</code> to disable cgo.</p>
<p>A simle cgo:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// typedef int (*intFunc) ();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// int</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// bridge_int_func(intFunc f)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//		return f();</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// }</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// int fortytwo()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// {</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">//	    return 42;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// }</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;C&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> <span style="color:#e6db74">&#34;fmt&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">intFunc</span>(<span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">fortytwo</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(int(<span style="color:#a6e22e">C</span>.<span style="color:#a6e22e">bridge_int_func</span>(<span style="color:#a6e22e">f</span>)))
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// Output: 42</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Then compile it with <code>CGO_ENABLED=0</code> on Ubuntu machine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ CGO_ENABLED<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> go build -o server main.go
</span></span><span style="display:flex;"><span>go: no Go source files
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [20:58:50] C:1</span>
</span></span><span style="display:flex;"><span>$ go build -o server main.go 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [21:00:15] </span>
</span></span><span style="display:flex;"><span>$ file server 
</span></span><span style="display:flex;"><span>server: ELF 64-bit LSB executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>SYSV<span style="color:#f92672">)</span>, dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, BuildID<span style="color:#f92672">[</span>sha1<span style="color:#f92672">]=</span>da0674602632e4f540cfe58f0be1ffa261f2eefe, <span style="color:#66d9ef">for</span> GNU/Linux 3.2.0, with debug_info, not stripped
</span></span></code></pre></div><p>Then we can use <code>-ldflags</code> to tell the C linker to statically link with <code>-extldflags</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">-</span><span style="color:#a6e22e">ldflags</span>=<span style="color:#e6db74">&#34;-extldflags=-static&#34;</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [21:00:18] </span>
</span></span><span style="display:flex;"><span>$ go build -ldflags<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;-extldflags=-static&#34;</span> -o server main.go
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ubuntu @ ip-172-31-12-228 in ~/codes [21:01:41] </span>
</span></span><span style="display:flex;"><span>$ file server 
</span></span><span style="display:flex;"><span>server: ELF 64-bit LSB executable, x86-64, version <span style="color:#ae81ff">1</span> <span style="color:#f92672">(</span>GNU/Linux<span style="color:#f92672">)</span>, statically linked, BuildID<span style="color:#f92672">[</span>sha1<span style="color:#f92672">]=</span>4031763b8f09ffcd1455840afe89c4644eca0088, <span style="color:#66d9ef">for</span> GNU/Linux 3.2.0, with debug_info, not stripped
</span></span></code></pre></div><p>Now it&rsquo;s statically linked.</p>
<p>I hope you can understand the difference between <code>CGO_ENABLED=0</code> and <code>-ldflags=&quot;-extldflags=-static&quot;</code> flag, and when you should use which one. Besides, you should know the different behavior on MacOS and Linux for statically linking in Go. And the two common command <code>ldd</code>,  <code>otool</code>, <code>file</code> will help you.</p>
<p>Learn more:</p>
<ul>
<li><a href="https://www.arp242.net/static-go.html">Statically compiling Go programs</a></li>
<li><a href="https://blog.hashbangbash.com/2014/04/linking-golang-statically/">#!bash blog/2014/04/linking-golang-statically/</a></li>
<li><a href="https://dave.cheney.net/tag/cgo">cgo | Dave Cheney</a></li>
<li><a href="https://mt165.co.uk/blog/static-link-go/index.html">Matt Turner - Statically Linking Go in 2022</a></li>
</ul>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">查看其他文章</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="https://blog.jiyi27.com/posts/docker/002-docker-architecture/" class="button inline prev">
        Docker Architecture
      </a>
    
    
      ::
    
    
      <a href="https://blog.jiyi27.com/posts/golang/advance/011-cross-compilation/" class="button inline next">
        Cross Compilation - Go
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/jiyi27/jiyi27.github.io" target="_blank">Theme</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
