<!DOCTYPE html>
<html lang="en">
<head>
  
    
    <title>Error handling - Go :: 为霜的博客</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="0. Use %w instead of %v or %s Should I use %s or %v to format errors? return fmt.Errorf(&quot;malformed import path %q: %v&quot;, path, err)
Neither. Use %w in 99.99% of cases. In the other 0.001% of cases, %v and %sprobably &ldquo;should&rdquo; behave the same, except when the error value is nil, but there are no guarantees. The friendlier output of %v for nil errors may be reason to prefer %v (see below).
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://blog.jiyi27.com/posts/golang/basics/007-error-handling/" />





  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/categories.min.3202f75cbb294747099af3850a68a09ee94b3ce505fc39e134692d90ff0a9b2a.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/code.min.dd73d157e77e82a3dc1cb06ba424cf6cc6811af0bb604ad6c68e70faf2439c8a.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/main.min.3fb8954e26342ad3afabb4525959bfec6f9fc0d6929f0dda738ddeee30211690.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/menu.min.8cee75f73b9f9b1e40bd0dd53e6e770156b08bbfe1c579cd256c3f6cd3b6d32b.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/post.min.014a50745fbdd41d5f420a3e288730d5af4b7d90344dc6211d0e50c368b5b303.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/prism.min.b958d3d7c6c67361b945f9062d07d403422604b3d2cd33f93b88d41ed0ba634d.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/term.min.94de320c1b850e126e6d2c88a7c90acf58bb1313f0ea14a14cda2a42f2a88db2.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="https://blog.jiyi27.com/terminal.css">




<link rel="shortcut icon" href="https://blog.jiyi27.com/favicon.png">
<link rel="apple-touch-icon" href="https://blog.jiyi27.com/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Error handling - Go">
<meta property="og:description" content="0. Use %w instead of %v or %s Should I use %s or %v to format errors? return fmt.Errorf(&quot;malformed import path %q: %v&quot;, path, err)
Neither. Use %w in 99.99% of cases. In the other 0.001% of cases, %v and %sprobably &ldquo;should&rdquo; behave the same, except when the error value is nil, but there are no guarantees. The friendlier output of %v for nil errors may be reason to prefer %v (see below).
" />
<meta property="og:url" content="https://blog.jiyi27.com/posts/golang/basics/007-error-handling/" />
<meta property="og:site_name" content="为霜的博客" />

  <meta property="og:image" content="https://blog.jiyi27.com/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">

  <meta property="article:section" content="golang" />


  <meta property="article:published_time" content="2023-09-08 09:13:06 &#43;0000 UTC" />












</head>
<body>


<div class="container center">

  
  
  

  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.jiyi27.com/posts/golang/basics/007-error-handling/">Error handling - Go</a>
  </h1>
  <div class="post-meta"><time class="post-date">2023-09-08</time><span class="post-reading-time">9 分钟阅读 (1849 字数)</span></div>

  
    <span class="post-tags">
      
      #<a href="https://blog.jiyi27.com/tags/golang/">golang</a>&nbsp;
      
      #<a href="https://blog.jiyi27.com/tags/%E9%94%99%E8%AF%AF%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86/">错误异常处理</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <h2 id="0-use-w-instead-of-v-or-s">0. Use <code>%w</code> instead of <code>%v</code> or <code>%s</code><a href="#0-use-w-instead-of-v-or-s" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<blockquote>
<p>Should I use %s or %v to format errors? <code>return fmt.Errorf(&quot;malformed import path %q: %v&quot;, path, err)</code></p>
<p>Neither. Use <code>%w</code> in 99.99% of cases. In the other 0.001% of cases, <code>%v</code> and <code>%s</code>probably &ldquo;should&rdquo; behave the same, except when the error value is <code>nil</code>, but there are no guarantees. The friendlier output of <code>%v</code> for <code>nil</code> errors may be reason to prefer <code>%v</code> (see below).</p>
<p>As of Go 1.13, you can use the <code>%w</code> verb, only for <code>error</code> values, which wraps the error such that it can later be unwrapped with <a href="https://golang.org/pkg/errors/#Unwrap"><code>errors.Unwrap</code></a>, and so that it can be considered with <a href="https://golang.org/pkg/errors/#Is"><code>errors.Is</code></a> and <a href="https://golang.org/pkg/errors/#As"><code>errors.As</code></a>.</p>
<p><a href="https://stackoverflow.com/a/61287626/16317008">Stackoverflow</a></p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ErrorKind</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">const</span> (
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">KindDatabase</span> <span style="color:#a6e22e">ErrorKind</span> = <span style="color:#66d9ef">iota</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">KindNotFound</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//KindValidation</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">//KindUnauthorized</span>
</span></span><span style="display:flex;"><span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ServerError</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Kind</span>    <span style="color:#a6e22e">ErrorKind</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Message</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Err</span>     <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// *ServerError implements error interface</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ServerError</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;%s: %v&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Message</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Message</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 这里添加 Is() 方法是为了 自定义 通过 errors.Is(err, target error) 比较错误时的比较逻辑</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 可以看到函数体中 我们先把 target 转为 *ServerError 再进行判断</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 这是因为 target 类型是 error 接口, 无法访问 Kind field </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 可是为什么我们的 Is() 函数的参数是 error 类型, 而不能是 *ServerError 类型呢?</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 还记得前面我们说的为什么要定义这个函数吗, 为了使用 errors.Is() 来比较两个我们的自定义错误是不是同一个 ErrorKind</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 你不知道的是 errors.Is() 内部会尝试调用两个参数的 Is() 方法 来判断两个 error 是否相等, </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 若我们的 Is() 方法的参数是 *ServerError 类型, 则会导致调用失败,</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// 因为 errors.Is(err, target error) 中的 err 和 target 都是 error 类型, 而不是 *ServerError 类型</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ServerError</span>) <span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">target</span> <span style="color:#66d9ef">error</span>) <span style="color:#66d9ef">bool</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 将 target (interface) 转换为 *ServerError 类型, 并将结果存储在 t 中</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">var</span> <span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">ServerError</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">As</span>(<span style="color:#a6e22e">target</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">t</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Kind</span> <span style="color:#f92672">==</span> <span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Kind</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewDatabaseError</span>(<span style="color:#a6e22e">msg</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ServerError</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ServerError</span>{
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">Kind</span>:    <span style="color:#a6e22e">KindDatabase</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">Message</span>: <span style="color:#a6e22e">msg</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">Err</span>:     <span style="color:#a6e22e">err</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewNotFoundError</span>(<span style="color:#a6e22e">msg</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">ServerError</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">ServerError</span>{
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">Kind</span>:    <span style="color:#a6e22e">KindNotFound</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">Message</span>: <span style="color:#a6e22e">msg</span>,
</span></span><span style="display:flex;"><span>       <span style="color:#a6e22e">Err</span>:     <span style="color:#a6e22e">err</span>,
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 创建两个基础错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">baseErr1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDatabaseError</span>(<span style="color:#e6db74">&#34;connection failed&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">baseErr2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDatabaseError</span>(<span style="color:#e6db74">&#34;query failed&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 它们的 Kind 相同，但 Message 不同</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 1. 直接比较</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">baseErr1</span>, <span style="color:#a6e22e">baseErr2</span>)) <span style="color:#75715e">// true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 为什么是 true？因为我们的 Is() 方法只比较 Kind 字段</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 2. 使用 %w 包装</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wrap1</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;operation failed: %w&#34;</span>, <span style="color:#a6e22e">baseErr1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">wrap1</span>, <span style="color:#a6e22e">baseErr2</span>)) <span style="color:#75715e">// true</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 为什么是 true？因为：</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// - %w 保持了错误链，errors.Is 可以通过 Unwrap 找到 baseErr1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// - 然后调用 baseErr1.Is(baseErr2)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// - 发现两者的 Kind 都是 KindDatabase，返回 true</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 3. 使用 %v 包装</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wrap2</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;operation failed: %v&#34;</span>, <span style="color:#a6e22e">baseErr1</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">wrap2</span>, <span style="color:#a6e22e">baseErr2</span>)) <span style="color:#75715e">// false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 为什么是 false？因为：</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// - %v 只是创建了一个新的字符串错误，切断了错误链</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// - wrap2 变成了一个普通的 error，没有 Unwrap 方法</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// - errors.Is 无法找到原始的 baseErr1</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// - 所以无法调用 baseErr1.Is(baseErr2)</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 4. 验证错误种类</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">dbErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDatabaseError</span>(<span style="color:#e6db74">&#34;some error&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">notFoundErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewNotFoundError</span>(<span style="color:#e6db74">&#34;not found&#34;</span>, <span style="color:#66d9ef">nil</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">Is</span>(<span style="color:#a6e22e">dbErr</span>, <span style="color:#a6e22e">notFoundErr</span>)) <span style="color:#75715e">// false</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 为什么是 false？因为：</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// - dbErr.Is(notFoundErr) 比较了两者的 Kind</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// - 一个是 KindDatabase，一个是 KindNotFound，不相等</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 5. 错误链示例</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">origErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;原始错误&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">serverErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDatabaseError</span>(<span style="color:#e6db74">&#34;db error&#34;</span>, <span style="color:#a6e22e">origErr</span>) <span style="color:#75715e">// origErr 存储在 Err 字段</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">wrapServerErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;wrap: %w&#34;</span>, <span style="color:#a6e22e">serverErr</span>)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;serverErr: %v\n&#34;</span>, <span style="color:#a6e22e">serverErr</span>)      <span style="color:#75715e">// 输出: db error: 原始错误</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;wrapServerErr: %v\n&#34;</span>, <span style="color:#a6e22e">wrapServerErr</span>) <span style="color:#75715e">// 输出: wrap: db error: 原始错误</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>errors.Is(err, target error)</code> 的工作流程：</p>
<ul>
<li>先尝试 Unwrap 找到原始错误</li>
<li>然后调用其参数 <code>err </code> 和 <code>target</code> 各自的 Is() 方法进行比较</li>
<li>如果找不到原始错误（比如用 %v 包装），就无法进行比较</li>
</ul>
<p>这也是为什么例子 <code>1.</code> 会返回 true, 也是为什么我们要自定义 <code>Is()</code> 函数</p>
<p>关键点解释：</p>
<ol>
<li>
<p><code>*ServerError</code> 的 <code>Is()</code> 方法的参数为什么是 <code>error</code> 而不是 <code>*ServerError</code>：</p>
<ul>
<li><code>errors.Is(err, target error)</code> 会尝试在这两个参数上调用 <code>Is</code> 方法</li>
<li>如果我们的 <code>Is</code> 方法参数是 <code>*ServerError</code>，那么当 <code>target</code> 是普通的 <code>error</code> 时，就无法调用这个方法</li>
<li>所以参数必须是 <code>error</code> 接口类型，然后在方法内部用 <code>errors.As</code> 转换为具体类型</li>
</ul>
</li>
<li>
<p><code>%w</code> vs <code>%v</code> 的区别：</p>
<ul>
<li><code>%w</code> 维持错误链，让 <code>errors.Is</code> 能够找到并使用原始错误的比较逻辑</li>
<li><code>%v</code> 创建新的错误，切断错误链，使得无法使用原始错误的比较逻辑</li>
</ul>
</li>
<li>
<p><code>ServerError</code> 的 <code>Is</code> 方法实现：</p>
<ul>
<li>只比较 <code>Kind</code> 字段，忽略 <code>Message</code> 和 <code>Err</code> 字段</li>
<li>使得同类型的错误（比如所有数据库错误）可以被认为是相等的</li>
<li>这种设计允许我们基于错误类型而不是具体消息来处理错误</li>
</ul>
</li>
</ol>
<h2 id="1error-interface">1.<code>error</code> interface<a href="#1error-interface" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>The <code>error</code> type is an interface type. An <code>error</code> variable represents any value that <strong>can</strong> describe itself as a string.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#66d9ef">error</span> <span style="color:#66d9ef">interface</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Interface <code>error</code> is a built-in type, as with all other built in types, is <a href="https://go.dev/doc/go_spec.html#Predeclared_identifiers">predeclared</a> in the <a href="https://go.dev/doc/go_spec.html#Blocks">universe block</a>. The most commonly-used <code>error</code> implementation is the <a href="https://go.dev/pkg/errors/">errors</a> package’s <strong>unexported</strong> <code>errorString</code> type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// errorString is a trivial implementation of error.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">errorString</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">s</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">errorString</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">s</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>errorString</code> is an unexported type which means we cannot use it directly outside of <a href="https://go.dev/pkg/errors/">errors</a> package, but we can use <code>New</code> function declared in the same package to create a value of <code>errorString</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// New returns an error that formats as the given text.</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">New</span>(<span style="color:#a6e22e">text</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">errorString</span>{<span style="color:#a6e22e">text</span>}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>The type of function returns is an <code>error</code> but it actually returns a pointer, a little weird probably for newb from c++. In Go everything can implement a interface an <code>int</code>, <code>string</code> even a <code>pointer</code>. It&rsquo;s all about if the method set of that type contians all the methods declared in a interface, learn more: <a href="https://davidzhu.xyz/post/golang/basics/013-methods-receivers/#3-pointer-receiver---a-practical-example">Methods Receivers &amp; Concurrency - Go - David&rsquo;s Blog</a></p>
<h2 id="2-summarize-the-context">2. Summarize the context<a href="#2-summarize-the-context" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<h3 id="21-ways-to-create-an-error-value">2.1. Ways to create an error value<a href="#21-ways-to-create-an-error-value" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>You can create an <code>error</code> with these functions:</p>
<ul>
<li><code>errors.New()</code>,</li>
<li><code>fmt.Errorf()</code>, often used to provide conetxt.</li>
<li>Use a custom error type, typically used for provide error details.</li>
</ul>
<h3 id="22-summarize-the-context-when-create-an-error-value">2.2. Summarize the context when create an error value<a href="#22-summarize-the-context-when-create-an-error-value" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p><strong>It is the error implementation’s responsibility to summarize the context.</strong> The error returned by <code>os.Open</code> formats as “open /etc/passwd: permission denied,” not just “permission denied.”</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Sqrt</span>(<span style="color:#a6e22e">f</span> <span style="color:#66d9ef">float64</span>) (<span style="color:#66d9ef">float64</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">f</span> &lt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>    	<span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;math: square root of negative number %g&#34;</span>, <span style="color:#a6e22e">f</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// implementation</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;math: failed to calculate sqrt: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h2 id="3-some-common-ways-for-error-handling">3. Some common ways for error handling<a href="#3-some-common-ways-for-error-handling" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>We have talked that there are three ways to create an error, now let&rsquo;s discuss how to use them in practice.</p>
<h3 id="31-create-error-value-with-a-custom-error-type---provide-details">3.1. Create error value with a custom error type - provide details<a href="#31-create-error-value-with-a-custom-error-type---provide-details" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>In many cases <code>fmt.Errorf</code> is good enough, but since <code>error</code> is an interface, you can use arbitrary data structures as error values, to allow callers to inspect the details of the error.</p>
<p>The <a href="https://go.dev/pkg/encoding/json/">json</a> package specifies a <code>SyntaxError</code> type that the <code>json.Decode</code> function returns when it encounters a syntax error parsing a JSON blob.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SyntaxError</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">msg</span>    <span style="color:#66d9ef">string</span> <span style="color:#75715e">// description of error</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">Offset</span> <span style="color:#66d9ef">int64</span>  <span style="color:#75715e">// error occurred after reading Offset bytes</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SyntaxError</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> { <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">msg</span> }
</span></span></code></pre></div><p>The <code>Offset</code> field isn’t even shown in the default formatting of the error, but callers can use it to add file and line information to their error messages:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dec</span>.<span style="color:#a6e22e">Decode</span>(<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">val</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">serr</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">SyntaxError</span>); <span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// serr.Offset provide detials about error</span>
</span></span><span style="display:flex;"><span>        <span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">col</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">findLine</span>(<span style="color:#a6e22e">f</span>, <span style="color:#a6e22e">serr</span>.<span style="color:#a6e22e">Offset</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;%s:%d:%d: %v&#34;</span>, <span style="color:#a6e22e">f</span>.<span style="color:#a6e22e">Name</span>(), <span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">col</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="32-dont-return-error-dirctly---avoid-repetitive-error-handling">3.2. Don&rsquo;t return error dirctly - avoid repetitive error handling<a href="#32-dont-return-error-dirctly---avoid-repetitive-error-handling" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<h4 id="321-return-a-bool-value-instead-to-indicate-an-abnormal-state">3.2.1. Return a <code>bool</code> value instead to indicate an abnormal state<a href="#321-return-a-bool-value-instead-to-indicate-an-abnormal-state" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<p>Here’s a simple example from the <code>bufio</code> package’s <a href="https://go.dev/pkg/bufio/#Scanner"><code>Scanner</code></a> type. Its <a href="https://go.dev/pkg/bufio/#Scanner.Scan"><code>Scan</code></a> method performs the underlying I/O, which can of course lead to an error. Yet the <code>Scan</code> method does not expose an error at all. Instead, it returns a boolean, and a separate method, to be run at the end of the scan, reports whether an error occurred. Client code looks like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">scanner</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewScanner</span>(<span style="color:#a6e22e">input</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> <span style="color:#a6e22e">scanner</span>.<span style="color:#a6e22e">Scan</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">token</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">scanner</span>.<span style="color:#a6e22e">Text</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// process token</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">scanner</span>.<span style="color:#a6e22e">Err</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// process the error</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Sure, there is a nil check for an error, but it appears and executes only once. The <code>Scan</code> method could instead have been defined as</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Scanner</span>) <span style="color:#a6e22e">Scan</span>() (<span style="color:#a6e22e">token</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>)
</span></span></code></pre></div><p>and then the example user code might be (depending on how the token is retrieved),</p>
<pre tabindex="0"><code>scanner := bufio.NewScanner(input)
for {
    token, err := scanner.Scan()
    if err != nil {
        return err // or maybe break
    }
    // process token
}
</code></pre><p>This isn’t very different, but there is one important distinction. In this code, the client must check for an error on every iteration, but in the real <code>Scanner</code> API, the error handling is abstracted away from the key API element, which is iterating over tokens. With the real API, the client’s code therefore feels more natural: loop until done, then worry about errors. Error handling does not obscure the flow of control.</p>
<h4 id="321-return-nothing">3.2.1. Return nothing<a href="#321-return-nothing" class="hanchor" ariaLabel="Anchor">#</a> </h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">fd</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">p0</span>[<span style="color:#a6e22e">a</span>:<span style="color:#a6e22e">b</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">fd</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">p1</span>[<span style="color:#a6e22e">c</span>:<span style="color:#a6e22e">d</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">fd</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">p2</span>[<span style="color:#a6e22e">e</span>:<span style="color:#a6e22e">f</span>])
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and so on</span>
</span></span></code></pre></div><p>The code above is very repetitive. A function literal closing over the error variable would help:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">write</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">buf</span> []<span style="color:#66d9ef">byte</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">p0</span>[<span style="color:#a6e22e">a</span>:<span style="color:#a6e22e">b</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">p1</span>[<span style="color:#a6e22e">c</span>:<span style="color:#a6e22e">d</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">p2</span>[<span style="color:#a6e22e">e</span>:<span style="color:#a6e22e">f</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and so on</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This pattern works well, but requires a closure in each function doing the writes; a separate helper function is clumsier to use because the <code>err</code> variable needs to be maintained across calls (try it).</p>
<p>We can make this cleaner, more general, and reusable by borrowing the idea from the <code>Scan</code> method above.</p>
<p>I defined an object called an <code>errWriter</code>, something like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">errWriter</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">w</span>   <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Writer</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>and gave it one method, <code>write.</code> It doesn’t need to have the standard <code>Write</code> signature, and it’s lower-cased in part to highlight the distinction. The <code>write</code> method calls the <code>Write</code> method of the underlying <code>Writer</code> and records the first error for future reference:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ew</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">errWriter</span>) <span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">buf</span> []<span style="color:#66d9ef">byte</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ew</span>.<span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">ew</span>.<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">ew</span>.<span style="color:#a6e22e">w</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">buf</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>As soon as an error occurs, the <code>write</code> method becomes a no-op but the error value is saved.</p>
<p>Given the <code>errWriter</code> type and its <code>write</code> method, the code above can be refactored:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">ew</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">errWriter</span>{<span style="color:#a6e22e">w</span>: <span style="color:#a6e22e">fd</span>}
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ew</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">p0</span>[<span style="color:#a6e22e">a</span>:<span style="color:#a6e22e">b</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ew</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">p1</span>[<span style="color:#a6e22e">c</span>:<span style="color:#a6e22e">d</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ew</span>.<span style="color:#a6e22e">write</span>(<span style="color:#a6e22e">p2</span>[<span style="color:#a6e22e">e</span>:<span style="color:#a6e22e">f</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and so on</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">ew</span>.<span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ew</span>.<span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>This is cleaner, even compared to the use of a closure, and also makes the actual sequence of writes being done easier to see on the page. There is no clutter anymore. Programming with error values (and interfaces) has made the code nicer.</p>
<p>In fact, this pattern appears often in the standard library. The <a href="https://go.dev/pkg/archive/zip/"><code>archive/zip</code></a> and <a href="https://go.dev/pkg/net/http/"><code>net/http</code></a> packages use it. More salient to this discussion, the <a href="https://go.dev/pkg/bufio/"><code>bufio</code> package’s <code>Writer</code></a> is actually an implementation of the <code>errWriter</code> idea. Although <code>bufio.Writer.Write</code> returns an error, that is mostly about honoring the <a href="https://go.dev/pkg/io/#Writer"><code>io.Writer</code></a> interface. The <code>Write</code> method of <code>bufio.Writer</code> behaves just like our <code>errWriter.write</code> method above, with <code>Flush</code> reporting the error, so our example could be written like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bufio</span>.<span style="color:#a6e22e">NewWriter</span>(<span style="color:#a6e22e">fd</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">p0</span>[<span style="color:#a6e22e">a</span>:<span style="color:#a6e22e">b</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">p1</span>[<span style="color:#a6e22e">c</span>:<span style="color:#a6e22e">d</span>])
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">p2</span>[<span style="color:#a6e22e">e</span>:<span style="color:#a6e22e">f</span>])
</span></span><span style="display:flex;"><span><span style="color:#75715e">// and so on</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">Flush</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">Flush</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>There is one significant drawback to this approach, at least for some applications: there is no way to know how much of the processing completed before the error occurred. If that information is important, a more fine-grained approach is necessary. Often, though, an all-or-nothing check at the end is sufficient.</p>
<p>We’ve looked at just one technique for avoiding repetitive error handling code. Keep in mind that the use of <code>errWriter</code> or <code>bufio.Writer</code> isn’t the only way to simplify error handling, and this approach is not suitable for all situations. The key lesson, however, is that errors are values and the full power of the Go programming language is available for processing them.</p>
<p>References:</p>
<ul>
<li><a href="https://go.dev/blog/error-handling-and-go">Error handling and Go - The Go Programming Language</a></li>
<li><a href="https://go.dev/blog/errors-are-values">Errors are values - The Go Programming Language</a></li>
</ul>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">查看其他文章</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="https://blog.jiyi27.com/posts/networking/007-tun-tap-device/" class="button inline prev">
        TUN/TAP Devices
      </a>
    
    
      ::
    
    
      <a href="https://blog.jiyi27.com/posts/golang/advance/005-unit-test-commands/" class="button inline next">
        Unit Test Basic Commands - Go
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/jiyi27/jiyi27.github.io" target="_blank">Theme</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
