<!DOCTYPE html>
<html lang="en">
<head>
  
    
    <title>TUN/TAP Devices :: 为霜的博客</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="1. TUN/TAP Devices In computer networking, TUN and TAP are two different kernel virtual network devices. Though both are for tunneling purposes, TUN and TAP can&rsquo;t be used together because they transmit and receive packets at different layers of the network stack. TUN (network TUNnel) devices are used for IP packet-level tunneling, while TAP (network TAP) devices are used for Ethernet frame-level tunneling.
A network interface can be a physical device, called network interface controller (NIC), such as an ethernet card or wireless adapter, or a virtual device, such as a TUN or TAP interface.
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="https://blog.jiyi27.com/posts/networking/007-tun-tap-device/" />





  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/buttons.min.2bc533403a27dfe0e93105a92502b42ce4587e2e4a87d9f7d349e51e16e09478.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/categories.min.3202f75cbb294747099af3850a68a09ee94b3ce505fc39e134692d90ff0a9b2a.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/code.min.dd73d157e77e82a3dc1cb06ba424cf6cc6811af0bb604ad6c68e70faf2439c8a.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/fonts.min.4881f0c525f3ce2a1864fb6e96676396cebe1e6fcef1933e8e1dde7041004fb5.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/footer.min.2e3eb191baee58dd05a9f0104ac1fab0827bca7c64dafe0b2579f934c33a1d69.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/header.min.b6fb4423cf82a9f9d7abc9cd010223fa3d70a6526a3f28f8e17d814c06e18f9e.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/main.min.3fb8954e26342ad3afabb4525959bfec6f9fc0d6929f0dda738ddeee30211690.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/menu.min.8cee75f73b9f9b1e40bd0dd53e6e770156b08bbfe1c579cd256c3f6cd3b6d32b.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/pagination.min.82f6400eae7c7c6dc3c866733c2ec0579e4089608fea69400ff85b3880aa0d3c.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/post.min.014a50745fbdd41d5f420a3e288730d5af4b7d90344dc6211d0e50c368b5b303.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/prism.min.b958d3d7c6c67361b945f9062d07d403422604b3d2cd33f93b88d41ed0ba634d.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/term.min.94de320c1b850e126e6d2c88a7c90acf58bb1313f0ea14a14cda2a42f2a88db2.css">

  
  <link rel="stylesheet" href="https://blog.jiyi27.com/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">


<link rel="stylesheet" href="https://blog.jiyi27.com/terminal.css">




<link rel="shortcut icon" href="https://blog.jiyi27.com/favicon.png">
<link rel="apple-touch-icon" href="https://blog.jiyi27.com/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />

  
    <meta name="twitter:site" content="" />
  
    <meta name="twitter:creator" content="" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="TUN/TAP Devices">
<meta property="og:description" content="1. TUN/TAP Devices In computer networking, TUN and TAP are two different kernel virtual network devices. Though both are for tunneling purposes, TUN and TAP can&rsquo;t be used together because they transmit and receive packets at different layers of the network stack. TUN (network TUNnel) devices are used for IP packet-level tunneling, while TAP (network TAP) devices are used for Ethernet frame-level tunneling.
A network interface can be a physical device, called network interface controller (NIC), such as an ethernet card or wireless adapter, or a virtual device, such as a TUN or TAP interface.
" />
<meta property="og:url" content="https://blog.jiyi27.com/posts/networking/007-tun-tap-device/" />
<meta property="og:site_name" content="为霜的博客" />

  <meta property="og:image" content="https://blog.jiyi27.com/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">

  <meta property="article:section" content="计算机网络" />


  <meta property="article:published_time" content="2023-09-08 17:54:59 &#43;0000 UTC" />












</head>
<body>


<div class="container center">

  
  
  

  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="https://blog.jiyi27.com/posts/networking/007-tun-tap-device/">TUN/TAP Devices</a>
  </h1>
  <div class="post-meta"><time class="post-date">2023-09-08</time><span class="post-reading-time">4 分钟阅读 (803 字数)</span></div>

  
    <span class="post-tags">
      
      #<a href="https://blog.jiyi27.com/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/">计算机网络</a>&nbsp;
      
      #<a href="https://blog.jiyi27.com/tags/vpn/">vpn</a>&nbsp;
      
    </span>
  
  


  

  <div class="post-content"><div>
        <h2 id="1-tuntap-devices">1. TUN/TAP Devices<a href="#1-tuntap-devices" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>In computer networking, <strong>TUN</strong> and <strong>TAP</strong> are two different kernel <strong>virtual network devices</strong>. Though both are for tunneling purposes, TUN and TAP can&rsquo;t be used together because they transmit and receive packets at different layers of the network stack. TUN (network TUNnel) devices are used for IP packet-level tunneling, while TAP (network TAP) devices are used for Ethernet frame-level tunneling.</p>
<blockquote>
<p>A network interface can be a physical device, called network interface controller (NIC), such as an ethernet card or wireless adapter, or a virtual device, such as a TUN or TAP interface.</p>
<p>Source: <a href="https://www.baeldung.com/linux/create-check-network-interfaces">https://www.baeldung.com/linux/create-check-network-interfaces</a></p>
<p>TUN/TAP provides packet reception and transmission for user space programs. It can be seen as a simple Point-to-Point or Ethernet device, which, instead of receiving packets from physical media, receives them from user space program and instead of sending packets via physical media writes them to the user space program. It interacts with user space program not the kernel.</p>
<p>Source: <a href="https://docs.kernel.org/networking/tuntap.html">https://docs.kernel.org/networking/tuntap.html</a></p>
</blockquote>
<h2 id="2-tuntap--network-stack">2. TUN/TAP &amp; Network Stack<a href="#2-tuntap--network-stack" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>TUN/TAP is an operating-system interface for creating network interfaces managed by userspace. This is usually used to implement userspace Virtual Private Networks[<a href="https://www.gabriel.urdhr.fr/2021/05/08/tuntap/#fn1">1]</a> (VPNs), for example with <a href="https://openvpn.net/">OpenVPN</a>, <a href="https://www.gabriel.urdhr.fr/2017/08/02/foo-over-ssh/#tuntap-forwarding">OpenSSH</a> (<code>Tunnel</code> configuration or <code>-w</code> argument), <a href="https://code.ffdn.org/l2tpns/l2tpns">l2tpns</a>, etc.</p>
<pre tabindex="0"><code>+--------------------------------------------+
| Processes                                  |
+--------------------------------------------+
  ↕ Socket interface
+---------------------------------------------+
| Network Stack (kernel)                      |&lt;--+
+---------------------------------------------+   |
  ↕ Eth. frame     ↕ Eth. frame    ↕ IP packet    |
+--------------+ +-------------+ +------------+   |
| enp2s0       | | tap0        | | tun0       |   |
+--------------+ +-------------+ +------------+   |
  ↑ Eth. frame     ↕ Eth. frame¹   ↕ IP packet¹   |
+--------------+ +-------------+ +------------+   |
| Driver       | | Process     | | Process    |   |
+--------------+ +-------------+ +------------+   |
  ↕ Eth. frame²    ↑               ↑              |
+--------------+   +---------------+--------------+
| Eth. Adapter  |  (encapsulated packets)
+--------------+
  ↕ Eth. frame
+--------------+
| Eth. Network |
+--------------+
Physical netdev    Ethernet VPN      IP VPN


¹: via /dev/net/tun
²: over PCI Express for example
</code></pre><p>There are many applications running on our OS (reside in user space), they send network packets with socket interface (on linux). All the packets through <strong>socket interface</strong> will go to one place: the <strong>Network Stack</strong> (resides in kernel). And the packets from the Network Stack only have two direction to go, one is the physical network interfce (<strong>NIC</strong>), another direction is the virtual network devices <strong>tap/tun</strong>, and we can get the packets from tap/tun which usually used in VPN application (resides in user space). Of course, VPN applicatipn (user space) can write packet into <strong>tap/tun</strong> devices and after written into tap/tun the packet will goes to <strong>Network Stack</strong>, and there are two direction again&hellip;</p>
<p>You probably notice that if we use TUN/TAP devices to handle the packets from other normal  applications, the packet seem to go through the Network Stack twice: the normal applications write data into socket interface and these packets will go through Netwok Stack and intercepted by TUN/TAP devices, then after vpn handles these packets, these packet will be sent to Network Stack again, which probably not efficient. (Notice that in qemu-kvm, tap device works with bridge, and the packets goes to bridge directly without going through Network Stack which is more efficient)</p>
<p>Applications send or receive packet to/from socket interface:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> socket <span style="color:#f92672">=</span> <span style="color:#a6e22e">socket</span>(AF_PACKET,SOCK_RAW,IPPROTO_IP)
</span></span></code></pre></div><p>VPN application send or receive packet to/from tun devices:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#75715e">// Request a TUN device
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> fd <span style="color:#f92672">=</span> <span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;/dev/net/tun&#34;</span>, O_RDWR);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// receives a (single) packet or frame from the virtual network interface;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Read an IP packet (because TUN works on IP layer):
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">ssize_t</span> count <span style="color:#f92672">=</span> <span style="color:#a6e22e">read</span>(fd, buffer, BUFFLEN);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// sends a (single) packet or frame to the virtual network interface;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">write</span>(...) 
</span></span></code></pre></div><p>Source: <a href="https://www.gabriel.urdhr.fr/2021/05/08/tuntap/">TUN/TAP interface (on Linux) - /dev/posts/</a></p>
<h2 id="3-tun-vs-tap">3. TUN vs. TAP<a href="#3-tun-vs-tap" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>There are two types of virtual network interfaces managed by <code>/dev/net/tun</code>:</p>
<ul>
<li>TUN interfaces transport IP packets (layer 3);</li>
<li>TAP interfaces transport Ethernet frames (layer 2).</li>
</ul>
<h3 id="31-tun-interfaces-l3">3.1. TUN interfaces (L3)<a href="#31-tun-interfaces-l3" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>TUN interfaces (<code>IFF_TUN</code>) transport layer 3 (L3) Protocol Data Units (PDUs):</p>
<ul>
<li>in practice, it transports IPv4 and/or IPv6 packets;</li>
<li><code>read()</code> gets a L3 PDU (an IP packet);</li>
<li>you must <code>write()</code> L3 PDUs (an IP packet);</li>
<li>there is no layer 2 (Ethernet, etc.) involved in the interface;</li>
</ul>
<h3 id="32-tap-interfaces-l2">3.2. TAP interfaces (L2)<a href="#32-tap-interfaces-l2" class="hanchor" ariaLabel="Anchor">#</a> </h3>
<p>TAP interfaces (<code>IFF_TUN</code>) transport layer 2 (L2) PDUs:</p>
<ul>
<li>in practice, it transports Ethernet frames (i.e. this is a virtual Ethernet adapter);</li>
<li><code>read()</code> gets a L2 PDU;</li>
<li>you must <code>write()</code> L2 PDUs.</li>
</ul>
<p>Source: <a href="https://www.gabriel.urdhr.fr/2021/05/08/tuntap/">TUN/TAP interface (on Linux) - /dev/posts/</a></p>
<h2 id="4-set-up-tuntap-devices">4. Set up TUN/TAP devices<a href="#4-set-up-tuntap-devices" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Because TUN is a layer 3 connection, it acts as a point-to-point link. We’ll assign these parameters:</p>
<ul>
<li>local address (for your machine): 192.0.2.1</li>
<li>remote address (for Scapy): 192.0.2.2</li>
</ul>
<p>On Linux, you would use:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo ip link set tun0 up
</span></span><span style="display:flex;"><span>sudo ip addr add 192.0.2.1 peer 192.0.2.2 dev tun0 
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sudo ip addr add 192.0.2.1 peer 192.0.2.2 dev tun0  up</span>
</span></span></code></pre></div><p>On BSD and macOS, use:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>sudo ifconfig tun0 up
</span></span><span style="display:flex;"><span>sudo ifconfig tun0 192.0.2.1 192.0.2.2
</span></span><span style="display:flex;"><span><span style="color:#75715e"># sudo ifconfig tun0 192.0.2.1 192.0.2.2 up</span>
</span></span></code></pre></div><p>Source: <a href="https://scapy.readthedocs.io/en/latest/layers/tuntap.html#tuntapinterface-reference">https://scapy.readthedocs.io/en/latest/layers/tuntap.html#tuntapinterface-reference</a></p>

      </div></div>

  
    
<div class="pagination">
  <div class="pagination__title">
    <span class="pagination__title-h">查看其他文章</span>
    <hr />
  </div>
  <div class="pagination__buttons">
    
      <a href="https://blog.jiyi27.com/posts/networking/004-ddos-attack/" class="button inline prev">
        DDoS Attack
      </a>
    
    
      ::
    
    
      <a href="https://blog.jiyi27.com/posts/golang/basics/007-error-handling/" class="button inline next">
        Error handling - Go
      </a>
    
  </div>
</div>


  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/jiyi27/jiyi27.github.io" target="_blank">Theme</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
