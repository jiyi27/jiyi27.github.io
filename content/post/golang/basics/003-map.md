---
title: Map - Go
date: 2023-12-06 23:43:50
categories:
 - golang
 - basics
tags:
 - golang
---

## 1. Basic concepts

A map value is a pointer to a `runtime.hmap` structure, when you write the statement:

```go
m := make(map[int]int)
```

The compiler replaces it with a call to [`runtime.makemap`](https://golang.org/src/runtime/hashmap.go#L222), which has the signature

```go
// makemap implements a Go map creation make(map[k]v, hint)
// If the compiler has determined that the map or the first bucket
// can be created on the stack, h and/or bucket may be non-nil.
// If h != nil, the map can be created directly in h.
// If bucket != nil, bucket can be used as the first bucket.
func makemap(t *maptype, hint int64, h *hmap, bucket unsafe.Pointer) *hmap
```

```go
func main() {
	var m map[int]int
	var p uintptr
	fmt.Println(unsafe.Sizeof(m), unsafe.Sizeof(p)) // 8 8 (linux/amd64)
}
```

> ⚠️ Map value just a pointer, therefore, we don't need to pass a pointer to a map for better performance. This is similar to slices, slice just a struct that has a pointer element which pointer to an underlaying array, so we don't need to set a pointer of slice as a paramter. This also applys function's return type. 

> Maps, like channels, but **unlike** slices, are just pointers to `runtime` types. As you saw above, a map is just a pointer to a `runtime.hmap` structure.  

Learn more: [maps | Dave Cheney](https://dave.cheney.net/tag/maps)

## 2. `var` vs `make()`

In [previous post](https://davidzhu.xyz/post/golang/basics/003-array-slice/) we know that you can append a `nil` slice directly, but this is not the case in a map:

```go
var cats map[string]int
// panic: assignment to entry in nil map
cats["Coco"] = 3
```

Therefore, for map you should use `make` or `map literal`

```go
// They are equivlent
cats := map[string]int{}
dogs := make(map[string]int)
```

## 3. Commone usage of map

### 3.1. Use map as a counter

```go
// as a counter
counts := make(map[string]int)
for name := range users {
	counts[name]++
}
// check if exist, O(1)
ele, ok := m["key"]
if !ok {...}
```

### 3.2. Copy map

Find a [blog](https://web.archive.org/web/20171006194258/https://stackoverflow.com/documentation/go/732/maps/9834/copy-a-map#t=20171006194258443316) talks copy map, share it here:

Like slices, maps hold references to an underlying data structure. So by assigning its value to another variable, only the reference will be passed. To copy the map, it is necessary to create another map and copy each value:

```go
// Create the original map
originalMap := make(map[string]int)
originalMap["one"] = 1
originalMap["two"] = 2

// Create the target map
targetMap := make(map[string]int)

// Copy from the original map to the target map
for key, value := range originalMap {
  targetMap[key] = value
}
```

Deep copy a map or slice: [encoding/gob & encoding/json in golang - David's Blog](https://shaowenzhu.top/post/golang/basics/014-gob-json-encoding/#24-values-are-flattened)

