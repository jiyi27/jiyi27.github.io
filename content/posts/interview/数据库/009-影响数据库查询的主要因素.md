---
title: 影响数据库查询的主要因素
date: 2025-04-23 20:18:45
categories:
 - 面试
tags:
 - 面试
 - 数据库面试
 - mysql
---

**(1) 磁盘 I/O 次数**

- 磁盘访问速度远低于内存. 频繁的磁盘读取/写入会严重影响性能, **最主要的瓶颈之一**
- 比如：查询没有命中索引，就要扫描大量数据页，导致大量 I/O

**(2) 网络 I/O**

- 通常在本地数据库中影响较小，除非是跨地域、大量数据传输
- 主要在**分布式数据库**或**客户端-服务器**架构下才会成为瓶颈

**(3) Join 的实现方式与次数**

- Join 本质上会涉及多个表的数据访问
- **Join 的次数和方式**（Nested Loop、Hash Join、Merge Join）会直接影响 I/O 次数和 CPU 计算量
- 可以理解为“Join 越多，可能导致 I/O 次数越多”，但不等同于“Join 次数 = I/O 次数”

> 现在有一个问题, 一般我们如何粗略计算 磁盘 IO 次数 来判断查询效率? 比如一次查询, 需要考虑哪些呢?
>
> 数据库把数据存储在 page 里, 常见的大小是 8KB（MySQL/InnoDB）或 4KB（PostgreSQL）, **一次磁盘 I/O 一般指读取一个页到内存**
>
> **是否命中索引？**
>
> 命中索引：
>
> - 需要读取索引页（几页）+ 数据页（通常 1 页）
> - 查询主键，一般只需要 **1~3 次 I/O**
>
> 未命中索引（全表扫描）：
>
> - 需要读取整个表的数据页数
>
> - 数据页数 = 表大小 / 页大小（如 1GB 表 / 8KB = ~131,000 页 = 131,000 次 I/O）
>
>  **索引结构的深度（B+树）**
>
> 假设一棵 B+树高度为 3：
>
> - 查询需要读取 **根节点 + 中间节点 + 叶子节点** = 3 次 I/O
> - 如果再加上数据行本身，也许是 4 次
>
> **是否走了回表？**
>
> - 如果你查询了非聚簇索引上的字段，还需要回到聚簇索引找完整行
> - 一次“回表”= 至少 1 次 I/O
>
> **缓存命中**
>
> 若数据页已在内存，I/O 为 0

我觉得有几点需要澄清:

1. 索引和数据是分开存储的吗?
2. 找到索引后, 直接就能定位到数据吗 类似 O(1) 复杂度?
3. 查找索引的复杂度为什么只和 B+ 树的高度有关系

**第一个问题:**

| 索引类型                   | 数据存储在哪里？                      | 是否需要回表 |
| -------------------------- | ------------------------------------- | ------------ |
| **主键（聚簇索引）**       | **数据直接存储在索引的叶子节点**      | ❌ 不需要回表 |
| **辅助索引（非聚簇索引）** | 索引只存储“键 + 主键值”，不含整行数据 | ✅ 需要回表   |

- 也就是说如果你查的是主键（聚簇索引），查到了叶子节点，**就等于查到了整行数据**
- 如果你查的是非主键（辅助索引），叶子节点只有部分信息，需要**“通过主键值再去聚簇索引查一次”**，这就是所谓“回表”

**第二个问题:**

分两种情况, 如果找到的是主键索引, 那就等于找到了数据行本身, 因为主键索引的顺序就是实际数据的顺序, 他们的位置是一样的, 都在 B+ 树的同一个叶子上

如果找到的是二级索引, 也就是相当于你知道了主键是什么, 此时想获取数据行的所有数据, 需要回表, 那就要在 主键的 B+ 树上再走一边,  也是 `O(lgn)`

例如，假设有一个表 `users(id, name, age)`，其中 `id` 是主键，`name` 上有一个辅助索引, 如果你执行 `SELECT id, name FROM users WHERE name = 'Alice'`：

- MySQL 会在 `name` 的辅助索引 B+ 树中查找，找到 `name = 'Alice'` 的叶子节点，这个节点会包含 `name` 和对应的 `id`（主键值）

- 如果查询需要的数据不在辅助索引中（例如，你需要 `age` 列，而 `age` 不在 `name` 的辅助索引中），MySQL 需要拿着查到的主键值（`id`），去聚簇索引（主键索引）的 B+ 树中查找整行数据, 这个过程叫**回表**
- 回表的查找仍然是基于 B+ 树，时间复杂度为 `O(log n)`，因为需要从聚簇索引的根节点遍历到叶子节点