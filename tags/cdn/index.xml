<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Cdn on 为霜的博客</title>
    <link>https://blog.jiyi27.com/tags/cdn/</link>
    <description>Recent content in Cdn on 为霜的博客</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>en</language>
    <lastBuildDate>Wed, 15 Nov 2023 20:09:22 +0000</lastBuildDate><atom:link href="https://blog.jiyi27.com/tags/cdn/index.xml" rel="self" type="application/rss+xml" />
    <item>
      <title>Get Free TLS certificate with Cloudflare</title>
      <link>https://blog.jiyi27.com/posts/build-website/008-cloudflare-cdn/</link>
      <pubDate>Wed, 15 Nov 2023 20:09:22 +0000</pubDate>
      
      <guid>https://blog.jiyi27.com/posts/build-website/008-cloudflare-cdn/</guid>
      <description>&lt;h2 id=&#34;1-hosting-your-domain-on-cloudflare-enable-cdn&#34;&gt;1. Hosting your domain on Cloudflare (Enable CDN)&lt;/h2&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;client &amp;lt;----tls-1----&amp;gt; cloudflare &amp;lt;----tls-2----&amp;gt; your server
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; You cannot login your server with &lt;code&gt;ssh user@your_domain&lt;/code&gt; any more after enabling Cloudflare. You need to login with &lt;code&gt;ssh user@your_ip&lt;/code&gt;. Cause the Cloudflare acts as a reverse proxy, it only forwards the http/https traffic to your server, and &lt;a href=&#34;https://developers.cloudflare.com/fundamentals/reference/network-ports/&#34;&gt;only on some specific ports&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;There are two steps to add your domain to Cloudflare:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Add your domain to Cloudflare&lt;/li&gt;
&lt;li&gt;Create and install TLS certificate to your server&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;Cloudflare does this by serving as a &lt;a href=&#34;https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/&#34;&gt;reverse proxy&lt;/a&gt; for your web traffic. Actually, Clooudflare achieves this by using its CDN service, which caches your website&amp;rsquo;s static content and serves it to your visitors from the nearest Cloudflare data center.
Refer to our Load Balancing reference architecture to learn more about advanced ways to forward traffic to your origins, as well as our &lt;a href=&#34;https://developers.cloudflare.com/reference-architecture/architectures/cdn/&#34;&gt;CDN reference architecture&lt;/a&gt; to learn more about how Cloudflare processes and optimizes your web traffic.&lt;/p&gt;</description>
      <content>&lt;h2 id=&#34;1-hosting-your-domain-on-cloudflare-enable-cdn&#34;&gt;1. Hosting your domain on Cloudflare (Enable CDN)&lt;/h2&gt;
&lt;pre tabindex=&#34;0&#34;&gt;&lt;code&gt;client &amp;lt;----tls-1----&amp;gt; cloudflare &amp;lt;----tls-2----&amp;gt; your server
&lt;/code&gt;&lt;/pre&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; You cannot login your server with &lt;code&gt;ssh user@your_domain&lt;/code&gt; any more after enabling Cloudflare. You need to login with &lt;code&gt;ssh user@your_ip&lt;/code&gt;. Cause the Cloudflare acts as a reverse proxy, it only forwards the http/https traffic to your server, and &lt;a href=&#34;https://developers.cloudflare.com/fundamentals/reference/network-ports/&#34;&gt;only on some specific ports&lt;/a&gt;.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;There are two steps to add your domain to Cloudflare:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Add your domain to Cloudflare&lt;/li&gt;
&lt;li&gt;Create and install TLS certificate to your server&lt;/li&gt;
&lt;/ul&gt;
&lt;blockquote&gt;
&lt;p&gt;Cloudflare does this by serving as a &lt;a href=&#34;https://www.cloudflare.com/learning/cdn/glossary/reverse-proxy/&#34;&gt;reverse proxy&lt;/a&gt; for your web traffic. Actually, Clooudflare achieves this by using its CDN service, which caches your website&amp;rsquo;s static content and serves it to your visitors from the nearest Cloudflare data center.
Refer to our Load Balancing reference architecture to learn more about advanced ways to forward traffic to your origins, as well as our &lt;a href=&#34;https://developers.cloudflare.com/reference-architecture/architectures/cdn/&#34;&gt;CDN reference architecture&lt;/a&gt; to learn more about how Cloudflare processes and optimizes your web traffic.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;11-add-your-domain-to-cloudflare&#34;&gt;1.1. Add your domain to Cloudflare&lt;/h3&gt;
&lt;p&gt;Go to this website: &lt;a href=&#34;https://dash.cloudflare.com/&#34;&gt;https://dash.cloudflare.com/&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/5ec8185791f488d73320ceadd0db79dc.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;And you will get instructions for updating your nameserver of your domain. After change your nameserver, waite about one hour, your site will be &lt;strong&gt;active&lt;/strong&gt; on Cloudflare. Then you can choose the TLS encryption mode:&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/3ff225afee4374761c3943c1c6ed009a.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note:&lt;/strong&gt; choose &lt;code&gt;full mode&lt;/code&gt;, don&amp;rsquo;t use &lt;code&gt;flexbile mode&lt;/code&gt;, otherwise you &lt;strong&gt;probably would&lt;/strong&gt; get &lt;a href=&#34;https://developers.cloudflare.com/ssl/troubleshooting/too-many-redirects/&#34;&gt;ERR_TOO_MANY_REDIRECTS&lt;/a&gt; when access your website.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&#34;12-install-tls-certificate&#34;&gt;1.2. Install TLS certificate&lt;/h3&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/d3d8aa4e52defcc7961fe8fad4d3eb88.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;p&gt;The generated two files &lt;code&gt;cert.pem&lt;/code&gt; and &lt;code&gt;cert.key&lt;/code&gt; is used for encryption between your server and Cloudflare.&lt;/p&gt;
&lt;p&gt;You can use these two file like this:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#f92672&#34;&gt;...&lt;/span&gt; 
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#66d9ef&#34;&gt;func&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;main&lt;/span&gt;() {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;http&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;HandleFunc&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;/hello&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;HelloServer&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;:=&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;http&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;ListenAndServeTLS&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;:443&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./conf/cert.pem&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;./conf/cert.key&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    &lt;span style=&#34;color:#66d9ef&#34;&gt;if&lt;/span&gt; &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt; &lt;span style=&#34;color:#f92672&#34;&gt;!=&lt;/span&gt; &lt;span style=&#34;color:#66d9ef&#34;&gt;nil&lt;/span&gt; {
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;        &lt;span style=&#34;color:#a6e22e&#34;&gt;log&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Fatal&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;ListenAndServe: &amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#a6e22e&#34;&gt;err&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;    }
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;}
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;blockquote&gt;
&lt;p&gt;&lt;strong&gt;Note&lt;/strong&gt;: don&amp;rsquo;t add the keep-alive header when handle request on your server, otherwise you may get a 520 error when you access your website on browser: &lt;code&gt;Error 520: Web server is returning an unknown error&lt;/code&gt;&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-go&#34; data-lang=&#34;go&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;w&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Header&lt;/span&gt;().&lt;span style=&#34;color:#a6e22e&#34;&gt;Set&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Connection&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Keep-Alive&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;&lt;span style=&#34;color:#a6e22e&#34;&gt;w&lt;/span&gt;.&lt;span style=&#34;color:#a6e22e&#34;&gt;Header&lt;/span&gt;().&lt;span style=&#34;color:#a6e22e&#34;&gt;Set&lt;/span&gt;(&lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;Keep-Alive&amp;#34;&lt;/span&gt;, &lt;span style=&#34;color:#e6db74&#34;&gt;&amp;#34;timeout=2, max=1000&amp;#34;&lt;/span&gt;)
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;/blockquote&gt;
&lt;p&gt;Learn more: &lt;a href=&#34;https://luyuhuang.tech/2020/06/03/cloudflare-free-https.html&#34;&gt;https://luyuhuang.tech/2020/06/03/cloudflare-free-https.html&lt;/a&gt;&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;After config this, the DNS needs time to take effect (you change the nameservers of your domain to Cloudfalre from the defatult nameservers, this needs time to take effect)&lt;/p&gt;
&lt;p&gt;If there still no HTTPS connection but the cloudflare displays your website &lt;strong&gt;is active&lt;/strong&gt; on their service, you may try to check if your server is listening on 443 port and try to flush the DNS cache of your client computer (chrome + system DNS cache). Learn more: &lt;a href=&#34;https://davidzhu.xyz/post/networking/002-dns-basics/&#34;&gt;DNS Concepts (NameServer(NS), DNS Records and Caching) - David&amp;rsquo;s Blog&lt;/a&gt;&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;BTW, you can check if your domain is proxied by the Cloudflare with nslookup command, which will get the &lt;code&gt;A Record&lt;/code&gt; by default (IPv4) address of your domain, but in this case, with Cloudfalre proxy, you should get the ip of Cloudfalre Name Server.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;pre tabindex=&#34;0&#34; style=&#34;color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;&#34;&gt;&lt;code class=&#34;language-shell&#34; data-lang=&#34;shell&#34;&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;❯ nslookup shaowenzhu.top
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Non-authoritative answer:
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Name:	shaowenzhu.top
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Address: 172.67.171.207 &lt;span style=&#34;color:#75715e&#34;&gt;# not my domain&amp;#39;s real ip, it&amp;#39;s Cloudfalre&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Name:	shaowenzhu.top
&lt;/span&gt;&lt;/span&gt;&lt;span style=&#34;display:flex;&#34;&gt;&lt;span&gt;Address: 104.21.47.185 &lt;span style=&#34;color:#75715e&#34;&gt;# not my domain&amp;#39;s real ip, it&amp;#39;s Cloudfalre&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;&lt;p&gt;Learn more: &lt;a href=&#34;https://developers.cloudflare.com/fundamentals/setup/account-setup/add-site/&#34;&gt;Add a site · Cloudflare Fundamentals docs&lt;/a&gt;&lt;/p&gt;
&lt;h2 id=&#34;2-change-a-record&#34;&gt;2. Change A record&lt;/h2&gt;
&lt;p&gt;If you changed a vps, all you need to do is to change the A record of your domain on Cloudflare, you don&amp;rsquo;t need to change the A record on your domain register website.&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Cloudflare serves as a &lt;strong&gt;reverse proxy&lt;/strong&gt;, directing all traffic for the specified proxied domain to the target IP address.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;&lt;img src=&#34;https://pub-2a6758f3b2d64ef5bb71ba1601101d35.r2.dev/blogs/2024/08/af17da33f67f363301b8d14cf87428ea.png&#34; alt=&#34;&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;3-allow-custom-port&#34;&gt;3. Allow custom port&lt;/h2&gt;
&lt;p&gt;The default port of https is 443. If you want to use other ports, you need to allow them with firewall first on your server.&lt;/p&gt;
&lt;p&gt;Cloudflare only allows the following &lt;strong&gt;HTTPS&lt;/strong&gt; ports:&lt;/p&gt;
&lt;p&gt;443
2053
2083
2087
2096
8443&lt;/p&gt;
&lt;p&gt;Very easy, you don&amp;rsquo;t need to do anything on Cloudflare, just allow the port on your server. Then you can access your website with &lt;code&gt;https://your_domain:port&lt;/code&gt;. And your traffic will be encrypted by Cloudflare.&lt;/p&gt;
&lt;p&gt;Learn more:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://community.cloudflare.com/t/how-to-allow-custom-port/175855&#34;&gt;How to allow custom port - Website, Application, Performance / Security - Cloudflare Community&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://developers.cloudflare.com/fundamentals/reference/network-ports/&#34;&gt;Network ports · Cloudflare Fundamentals docs&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Learn more about CDN:&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://www.cloudflare.com/learning/cdn/what-is-a-cdn/&#34;&gt;What is a content delivery network (CDN)? | How do CDNs work? | Cloudflare&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;a href=&#34;https://developers.cloudflare.com/reference-architecture/architectures/cdn/&#34;&gt;Reference Architecture: Cloudflare Content Delivery Network (CDN) · Cloudflare Reference Architecture docs&lt;/a&gt;&lt;/p&gt;
</content>
    </item>
    
  </channel>
</rss>
